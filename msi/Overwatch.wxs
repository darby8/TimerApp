<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

  <Product Id="*" Name="Overwatch" Language="1033" Version="1.0.0"
           Manufacturer="Reak"
           UpgradeCode="7F6B4E8D-1A3C-4F28-9E53-9C5B8A2E41D7">

    <Package InstallerVersion="500" Compressed="yes" InstallScope="perMachine"/>
    <MajorUpgrade DowngradeErrorMessage="A newer version is already installed."/>
    <MediaTemplate EmbedCab="yes"/>

    <!-- ========================= -->
    <!-- INSTALL DIRECTORIES -->
    <!-- ========================= -->

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="COMPANYDIR" Name="Reak">
          <Directory Id="INSTALLDIR" Name="Overwatch"/>
        </Directory>
      </Directory>

      <Directory Id="ProgramMenuFolder"/>
      <Directory Id="DesktopFolder"/>
    </Directory>

    <!-- ========================= -->
    <!-- INSTALL ALL FILES -->
    <!-- ========================= -->

    <DirectoryRef Id="INSTALLDIR">
      <Component Id="MainFiles" Guid="*">
        <File Source="msi\layout\appproject-overwatch.exe" KeyPath="yes"/>
        <File Source="msi\layout\Qt6Core.dll"/>
        <File Source="msi\layout\Qt6Gui.dll"/>
        <File Source="msi\layout\Qt6Widgets.dll"/>
      </Component>
    </DirectoryRef>

    <!-- ========================= -->
    <!-- DESKTOP SHORTCUT -->
    <!-- ========================= -->

    <DirectoryRef Id="DesktopFolder">
      <Component Id="DesktopShortcut" Guid="*" Directory="DesktopFolder">
        <Shortcut Id="DesktopSC"
                  Name="Overwatch"
                  Target="[INSTALLDIR]appproject-overwatch.exe"
                  WorkingDirectory="INSTALLDIR"/>
        <RegistryValue Root="HKCU"
                       Key="Software\Reak\Overwatch"
                       Name="Desktop"
                       Type="integer"
                       Value="1"
                       KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <!-- ========================= -->
    <!-- START MENU SHORTCUT -->
    <!-- ========================= -->

    <DirectoryRef Id="ProgramMenuFolder">
      <Directory Id="StartMenuDir" Name="Overwatch">

        <Component Id="StartMenuShortcut" Guid="*" Directory="StartMenuDir">
          <Shortcut Id="StartMenuSC"
                    Name="Overwatch"
                    Target="[INSTALLDIR]appproject-overwatch.exe"
                    WorkingDirectory="INSTALLDIR"/>
          <RemoveFolder Id="RemoveStartMenuDir" On="uninstall"/>
          <RegistryValue Root="HKCU"
                         Key="Software\Reak\Overwatch"
                         Name="StartMenu"
                         Type="integer"
                         Value="1"
                         KeyPath="yes"/>
        </Component>

      </Directory>
    </DirectoryRef>

    <!-- ========================= -->
    <!-- STARTUP (HKLM like NSIS) -->
    <!-- ========================= -->

    <Component Id="StartupRegistry" Guid="*" Directory="INSTALLDIR">
      <RegistryValue
        Root="HKLM"
        Key="Software\Microsoft\Windows\CurrentVersion\Run"
        Name="Overwatch"
        Value="[INSTALLDIR]appproject-overwatch.exe"
        Type="string"
        KeyPath="yes"/>
    </Component>

    <!-- ========================= -->
    <!-- DELETE APPDATA ON UNINSTALL -->
    <!-- ========================= -->

    <Property Id="CMD_EXE" Value="cmd.exe"/>

    <CustomAction
        Id="DeleteUserData"
        Property="CMD_EXE"
        ExeCommand='/c if exist "%APPDATA%\Reak\Overwatch" rmdir /s /q "%APPDATA%\Reak\Overwatch"'
        Execute="deferred"
        Impersonate="no"
        Return="ignore"/>

    <InstallExecuteSequence>
      <Custom Action="DeleteUserData" After="RemoveFiles">REMOVE="ALL"</Custom>
    </InstallExecuteSequence>

    <!-- ========================= -->
    <!-- FEATURES -->
    <!-- ========================= -->

    <Feature Id="MainFeature" Title="Overwatch" Level="1">
      <ComponentRef Id="MainFiles"/>
      <ComponentRef Id="DesktopShortcut"/>
      <ComponentRef Id="StartMenuShortcut"/>
      <ComponentRef Id="StartupRegistry"/>
    </Feature>

  </Product>

</Wix>
