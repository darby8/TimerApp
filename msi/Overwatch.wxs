<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

  <Product
    Id="*"
    Name="Overwatch"
    Language="1033"
    Version="1.0.0"
    Manufacturer="Reak"
    UpgradeCode="7F6B4E8D-1A3C-4F28-9E53-9C5B8A2E41D7">

    <Package InstallerVersion="500" Compressed="yes" InstallScope="perMachine"/>
    <!-- embed files inside MSI (no external cab) -->
    <MediaTemplate EmbedCab="yes"/>
    <MajorUpgrade DowngradeErrorMessage="A newer version is already installed."/>

    <!-- =============================
         Directory tree
         - ProgramFilesFolder -> INSTALLDIR (per-machine)
         - CommonDesktopFolder    (all users desktop)
         - CommonProgramsFolder -> StartMenuDir (all users start menu)
       ============================= -->
    <Directory Id="TARGETDIR" Name="SourceDir">

      <Directory Id="ProgramFilesFolder">
        <Directory Id="COMPANYDIR" Name="Reak">
          <Directory Id="INSTALLDIR" Name="Overwatch"/>
        </Directory>
      </Directory>

      <!-- All-users desktop -->
      <Directory Id="CommonDesktopFolder"/>

      <!-- All-users Start Menu Programs folder -->
      <Directory Id="CommonProgramsFolder">
        <Directory Id="StartMenuDir" Name="Overwatch"/>
      </Directory>

    </Directory>

    <!-- =============================
         Main application component
         - Contains the File (KeyPath)
         - Shortcuts are declared under the File so the file is KeyPath (no per-user/per-machine mix)
       ============================= -->
    <DirectoryRef Id="INSTALLDIR">
      <Component Id="MainExecutable" Guid="*">
        <File Source="msi\layout\appproject-overwatch.exe" KeyPath="yes">
          <!-- All-users desktop shortcut -->
          <Shortcut
            Id="OverwatchDesktopShortcut"
            Directory="CommonDesktopFolder"
            Name="Overwatch"
            WorkingDirectory="INSTALLDIR"
            Advertise="no"/>
          <!-- All-users Start Menu shortcut -->
          <Shortcut
            Id="OverwatchStartMenuShortcut"
            Directory="StartMenuDir"
            Name="Overwatch"
            WorkingDirectory="INSTALLDIR"
            Advertise="no"/>
        </File>

        <!-- remove the program folder on uninstall if empty -->
        <RemoveFolder Id="RemoveInstallDir" On="uninstall"/>

        <!-- per-machine registry key (non-keypath) to mark installation -->
        <RegistryValue Root="HKLM" Key="Software\Reak\Overwatch" Name="installed" Type="integer" Value="1" KeyPath="no"/>
      </Component>
    </DirectoryRef>

    <!-- =============================
         Ensure StartMenu folder is removed on uninstall.
         This is a separate component with a per-machine KeyPath (HKLM) â€” avoids ICE issues.
       ============================= -->
    <DirectoryRef Id="StartMenuDir">
      <Component Id="StartMenuFolderRemover" Guid="*">
        <RemoveFolder Id="RemoveStartMenuDir" On="uninstall"/>
        <!-- KeyPath must be a per-machine registry entry to satisfy ICE rules -->
        <RegistryValue Root="HKLM" Key="Software\Reak\Overwatch" Name="startmenu" Type="integer" Value="1" KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <!-- =============================
         AUTOSTART (ALL USERS) - per-machine registry under HKLM
       ============================= -->
    <Component Id="StartupRegistry" Directory="INSTALLDIR" Guid="*">
      <RegistryValue
        Root="HKLM"
        Key="Software\Microsoft\Windows\CurrentVersion\Run"
        Name="Overwatch"
        Value="[INSTALLDIR]appproject-overwatch.exe"
        Type="string"
        KeyPath="yes"/>
    </Component>

    <!-- =============================
         UNINSTALL: DELETE APPDATA (deferred, elevated)
         - Matches your NSIS RMDir /r "$APPDATA\Reak\Overwatch"
         - Placed as deferred and Impersonate="no" so it runs with system privileges
       ============================= -->
    <Property Id="CMD_EXE" Value="cmd.exe"/>

    <CustomAction
      Id="DeleteUserData"
      Property="CMD_EXE"
      ExeCommand='/c if exist "%APPDATA%\Reak\Overwatch" rmdir /s /q "%APPDATA%\Reak\Overwatch"'
      Execute="deferred"
      Impersonate="no"
      Return="ignore"/>

    <InstallExecuteSequence>
      <Custom Action="DeleteUserData" After="RemoveFiles">REMOVE="ALL"</Custom>
    </InstallExecuteSequence>

    <!-- =============================
         Feature
       ============================= -->
    <Feature Id="MainFeature" Title="Overwatch" Level="1">
      <ComponentRef Id="MainExecutable"/>
      <ComponentRef Id="StartMenuFolderRemover"/>
      <ComponentRef Id="StartupRegistry"/>
    </Feature>

  </Product>
</Wix>
