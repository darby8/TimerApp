<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

  <Product
    Id="*"
    Name="Overwatch"
    Language="1033"
    Version="1.0.0"
    Manufacturer="Reak"
    UpgradeCode="7F6B4E8D-1A3C-4F28-9E53-9C5B8A2E41D7">

    <Package InstallerVersion="500" Compressed="yes" InstallScope="perMachine"/>

    <MajorUpgrade DowngradeErrorMessage="A newer version is already installed."/>
    <MediaTemplate/>

    <!-- ============================= -->
    <!-- INSTALL DIRECTORY -->
    <!-- C:\Program Files\Reak\Overwatch -->
    <!-- ============================= -->

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="COMPANYDIR" Name="Reak">
          <Directory Id="INSTALLDIR" Name="Overwatch"/>
        </Directory>
      </Directory>

      <Directory Id="DesktopFolder"/>

      <Directory Id="ProgramMenuFolder">
        <Directory Id="StartMenuDir" Name="Overwatch"/>
      </Directory>
    </Directory>

    <!-- ============================= -->
    <!-- MAIN APPLICATION FILE -->
    <!-- ============================= -->

    <DirectoryRef Id="INSTALLDIR">
      <Component Id="MainExecutable" Guid="*">
        <File Source="msi\layout\appproject-overwatch.exe" KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <!-- ============================= -->
    <!-- DESKTOP SHORTCUT -->
    <!-- ============================= -->

    <DirectoryRef Id="DesktopFolder">
      <Component Id="DesktopShortcut" Guid="*">
        <Shortcut
          Id="DesktopShortcut"
          Name="Overwatch"
          Target="[INSTALLDIR]appproject-overwatch.exe"
          WorkingDirectory="INSTALLDIR"/>
        <RegistryValue Root="HKCU" Key="Software\Reak\Overwatch" Name="desktop" Type="integer" Value="1" KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <!-- ============================= -->
    <!-- START MENU SHORTCUT -->
    <!-- ============================= -->

    <DirectoryRef Id="StartMenuDir">
      <Component Id="StartMenuShortcut" Guid="*">
        <Shortcut
          Id="StartMenuShortcut"
          Name="Overwatch"
          Target="[INSTALLDIR]appproject-overwatch.exe"
          WorkingDirectory="INSTALLDIR"/>
        <RemoveFolder Id="RemoveStartMenuDir" On="uninstall"/>
        <RegistryValue Root="HKCU" Key="Software\Reak\Overwatch" Name="startmenu" Type="integer" Value="1" KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <!-- ============================= -->
    <!-- AUTO START (ALL USERS) -->
    <!-- ============================= -->

    <Component Id="StartupRegistry" Directory="TARGETDIR" Guid="*">
      <RegistryValue
        Root="HKLM"
        Key="Software\Microsoft\Windows\CurrentVersion\Run"
        Name="Overwatch"
        Value="[INSTALLDIR]appproject-overwatch.exe"
        Type="string"
        KeyPath="yes"/>
    </Component>

    <!-- ============================= -->
    <!-- UNINSTALL: DELETE APPDATA -->
    <!-- EXACT MATCH TO YOUR NSIS -->
    <!-- RMDir /r "$APPDATA\Reak\Overwatch" -->
    <!-- ============================= -->

    <Property Id="APPDATA_DIR" Value="[%APPDATA%]\Reak\Overwatch"/>
    
    <!-- Property that explicitly points to cmd.exe -->
    <Property Id="CMD_EXE" Value="cmd.exe"/>

<!-- Uninstall cleanup (EXACT NSIS BEHAVIOR) -->
    <CustomAction
       Id="DeleteUserData"
       Property="CMD_EXE"
       ExeCommand='/c if exist "%APPDATA%\Reak\Overwatch" rmdir /s /q "%APPDATA%\Reak\Overwatch"'
       Execute="deferred"
       Impersonate="no"
       Return="ignore"/>


    <InstallExecuteSequence>
      <Custom Action="DeleteUserData" After="RemoveFiles">REMOVE="ALL"</Custom>
    </InstallExecuteSequence>

    <!-- ============================= -->
    <!-- FEATURES -->
    <!-- ============================= -->

    <Feature Id="MainFeature" Title="Overwatch" Level="1">
      <ComponentRef Id="MainExecutable"/>
      <ComponentRef Id="DesktopShortcut"/>
      <ComponentRef Id="StartMenuShortcut"/>
      <ComponentRef Id="StartupRegistry"/>
    </Feature>

  </Product>

</Wix>

