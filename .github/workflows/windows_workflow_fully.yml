name: Windows Build & MSI Installer

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    env:
      QT_VERSION: 6.5.3
      BUILD_DIR: build
      APP_NAME: appproject-overwatch.exe

    steps:

      # -----------------------------
      # CHECKOUT
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive


      # -----------------------------
      # INSTALL PYTHON + AQT
      # -----------------------------
      - name: Install Python + aqt
        shell: cmd
        run: |
          python -m pip install --upgrade pip
          pip install aqtinstall==3.3.0


      # -----------------------------
      # INSTALL QT
      # -----------------------------
      - name: Install Qt 6.5.3 (MSVC2019)
        shell: pwsh
        run: |
          $qtBase = "$env:RUNNER_TEMP\Qt"

          python -m aqt install-qt windows desktop $env:QT_VERSION win64_msvc2019_64 `
            --outputdir $qtBase `
            --modules qtcharts qtmultimedia qtshadertools qtpositioning qtwebchannel qtwebengine qtwebview

          echo "CMAKE_PREFIX_PATH=$qtBase\$env:QT_VERSION\msvc2019_64" | Out-File -Append $env:GITHUB_ENV


      # -----------------------------
      # CONFIGURE + BUILD
      # -----------------------------
      - name: Configure CMake
        shell: pwsh
        run: |
          cmake -S . -B $env:BUILD_DIR `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -DCMAKE_PREFIX_PATH="$env:CMAKE_PREFIX_PATH"

      - name: Build project (Release)
        shell: pwsh
        run: |
          cmake --build $env:BUILD_DIR --config Release


      # -----------------------------
      # QT DEPLOY
      # -----------------------------
      - name: Deploy Qt (windeployqt)
        shell: pwsh
        run: |
          $QtBin = "$env:CMAKE_PREFIX_PATH\bin"

          & "$QtBin\windeployqt.exe" `
            "$env:BUILD_DIR\Release\$env:APP_NAME" `
            --release `
            --qmldir "$env:GITHUB_WORKSPACE\QML"

      - name: Copy QML folder
        shell: pwsh
        run: |
          xcopy QML "$env:BUILD_DIR\Release\QML" /E /I /Y


      # -----------------------------
      # RESTORE PFX CERT
      # -----------------------------
      - name: Restore PFX certificate
        shell: pwsh
        run: |
          $b64 = @"
          ${{ secrets.WINDOWS_CERT_PFX }}
          "@

          $bytes = [System.Convert]::FromBase64String($b64.Trim())
          $pfxPath = "$env:RUNNER_TEMP\codesign.pfx"
          [System.IO.File]::WriteAllBytes($pfxPath, $bytes)

          echo "PFX_PATH=$pfxPath" >> $env:GITHUB_ENV


      # -----------------------------
      # FIND SIGNTOOL
      # -----------------------------
      - name: Find signtool
        shell: pwsh
        run: |
          $signtool = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits\10" -Recurse -Filter signtool.exe |
                      Sort-Object FullName |
                      Select-Object -First 1

          if (-not $signtool) {
            Write-Error "âŒ signtool.exe not found!"
            exit 1
          }

          echo "SIGNTOOL=$($signtool.FullName)" >> $env:GITHUB_ENV


      # -----------------------------
      # SIGN EXE
      # -----------------------------
      - name: Sign Application EXE
        shell: pwsh
        env:
          PFX_PASSWORD: ${{ secrets.CODESIGN_PFX_PASSWORD }}
        run: |
          $exe = "$env:BUILD_DIR\Release\$env:APP_NAME"

          & $env:SIGNTOOL sign `
            /f "$env:PFX_PATH" `
            /p "$env:PFX_PASSWORD" `
            /fd SHA256 `
            /td SHA256 `
            /tr http://timestamp.digicert.com `
            /v `
            $exe


      # -----------------------------
      # INSTALL WIX
      # -----------------------------
      - name: Install WiX Toolset
        shell: pwsh
        run: |
          choco install wixtoolset -y


      # -----------------------------
      # PREPARE MSI LAYOUT
      # -----------------------------
      - name: Prepare MSI Layout
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force msi\layout | Out-Null
          Copy-Item "$env:BUILD_DIR\Release\*" "msi\layout" -Recurse -Force


      # -----------------------------
      # BUILD MSI
      # -----------------------------
      - name: Build MSI
        shell: pwsh
        run: |
          candle msi\Overwatch.wxs -o msi\Overwatch.wixobj
          light msi\Overwatch.wixobj -o msi\Overwatch.msi



      # -----------------------------
      # SIGN MSI
      # -----------------------------
      


      # -----------------------------
      # UPLOAD MSI
      # -----------------------------
      - name: Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Windows-MSI
          path: Overwatch.msi

