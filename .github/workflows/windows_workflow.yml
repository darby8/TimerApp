name: Windows Build & Deploy (MSVC)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    env:
      QT_VERSION: 6.8.3
      BUILD_DIR: build
      APP_NAME: appproject-overwatch.exe

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Install MSVC & Windows SDK properly
      - name: Setup MSVC Environment
        uses: microsoft/setup-msbuild@v2

      - name: Install Python & aqt
        shell: pwsh
        run: |
          pip install --upgrade pip
          pip install aqtinstall==3.3.0

      - name: Install Qt (MSVC 2022)
        shell: pwsh
        run: |
          $qtBase = "$env:RUNNER_TEMP\Qt"
          Write-Host "Installing Qt to: $qtBase"
          aqt install-qt windows desktop $env:QT_VERSION win64_msvc2022_64 `
            --outputdir $qtBase `
            --modules qtcharts qtmultimedia qtshadertools
          
          echo "CMAKE_PREFIX_PATH=$qtBase\$env:QT_VERSION\msvc2022_64" >> $env:GITHUB_ENV

      - name: Install DX Shader Compiler (Fix Qt Quick crash)
        shell: pwsh
        run: |
          Write-Host "Downloading DX Shader Compiler..."
          Invoke-WebRequest -Uri https://github.com/microsoft/DirectXShaderCompiler/releases/download/v1.7.2212/dxc_2022_12_16.zip -OutFile dxc.zip
          Expand-Archive dxc.zip -DestinationPath dxc
          Copy-Item dxc\bin\x64\dxcompiler.dll "$env:CMAKE_PREFIX_PATH\bin"
          Write-Host "DX shader compiler installed successfully."

      - name: Show Directory Debug Info
        shell: pwsh
        run: |
          Write-Host "===== Project Root ====="
          Get-ChildItem -Recurse -Depth 2

      - name: Configure CMake
        shell: pwsh
        run: |
          Write-Host "CMAKE_PREFIX_PATH = $env:CMAKE_PREFIX_PATH"
          cmake -S . -B $env:BUILD_DIR `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -DCMAKE_PREFIX_PATH="$env:CMAKE_PREFIX_PATH"

      - name: Build (Release)
        shell: pwsh
        run: |
          Write-Host "Starting Release Build..."
          cmake --build $env:BUILD_DIR --config Release

      - name: Deploy Qt (windeployqt)
        shell: pwsh
        run: |
          $QtBin = "$env:CMAKE_PREFIX_PATH\bin"
          Write-Host "Running windeployqt from: $QtBin"
          & "$QtBin\windeployqt.exe" "$env:BUILD_DIR\Release\$env:APP_NAME" `
            --release `
            --qmldir QML `
            --compiler-runtime `
            --pdb

          Write-Host "===== Resulting Output Files ====="
          Get-ChildItem "$env:BUILD_DIR\Release"

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: ${{ env.BUILD_DIR }}\Release

