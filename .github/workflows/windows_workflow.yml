name: Windows Configure & Build (Quick)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    env:
      QT_VERSION: 6.5.3
      BUILD_DIR: build
      APP_NAME: appproject-overwatch.exe
      INSTALLER_SRC: installer/input

    steps:
      # ðŸ§© Checkout code + submodules
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # ðŸ§© Install Python + aqtinstall
      - name: Install Python + aqt
        shell: cmd
        run: |
          python -m pip install --upgrade pip
          pip install aqtinstall==3.3.0

      # ðŸ§© Install Qt 6.5.3 with modules
      - name: Install Qt (6.5.3)
        shell: pwsh
        run: |
          $qtBase = "$env:RUNNER_TEMP\Qt"
          aqt install-qt windows desktop $env:QT_VERSION win64_msvc2019_64 `
            --outputdir $qtBase `
            --modules qtcharts qtmultimedia qtshadertools qtpositioning qtwebengine qtwebchannel qtwebview
          echo "CMAKE_PREFIX_PATH=$qtBase\$env:QT_VERSION\msvc2019_64" | Out-File -Append $env:GITHUB_ENV

      # ðŸ§© Configure CMake
      - name: Configure CMake
        shell: pwsh
        run: |
          cmake -S . -B $env:BUILD_DIR `
            -G "Visual Studio 16 2019" `
            -A x64 `
            -DCMAKE_PREFIX_PATH="$env:CMAKE_PREFIX_PATH"

      # ðŸ§© Build app (Release)
      - name: Build (Release)
        shell: pwsh
        run: cmake --build $env:BUILD_DIR --config Release

      # ðŸ§© Deploy Qt runtime (windeployqt)
      - name: Deploy Qt (windeployqt)
        shell: pwsh
        run: |
          $QtBin = "$env:CMAKE_PREFIX_PATH\bin"
          & "$QtBin\windeployqt.exe" `
            "$env:BUILD_DIR\Release\$env:APP_NAME" `
            --release `
            --qmldir "$env:GITHUB_WORKSPACE\QML"

      # ðŸ§© Copy QML folder
      - name: Copy QML folder
        shell: pwsh
        run: |
          xcopy QML "$env:BUILD_DIR\Release\QML" /E /I /Y

      # ðŸ§© Install NSIS via Chocolatey
      - name: Install NSIS
        shell: pwsh
        run: |
          choco install nsis -y
          $env:PATH += ";C:\Program Files (x86)\NSIS"
          echo "PATH=$env:PATH" | Out-File -Append $env:GITHUB_ENV

      # ðŸ§© Prepare installer payload folder
      - name: Create installer source folder
        shell: pwsh
        run: |
          New-Item -ItemType Directory "${{ env.INSTALLER_SRC }}" -Force | Out-Null
          Copy-Item -Path "${{ env.BUILD_DIR }}\Release\*" -Destination "${{ env.INSTALLER_SRC }}" -Recurse -Force

      # ðŸ§© Build the NSIS Installer
      - name: Build installer
        shell: pwsh
        run: |
          & "C:\Program Files (x86)\NSIS\makensis.exe" /V2 installer.nsi

      # ðŸ§© Upload installer artifact
      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Installer
          path: "*.exe"

