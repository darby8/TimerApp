name: Windows Qt Build & Installer

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    env:
      QT_VERSION: 6.8.3
      BUILD_DIR: build
      INSTALLER_SRC: installer/input

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Qt (aqt)
        shell: pwsh
        run: |
          pip install aqtinstall
          aqt install-qt windows desktop $env:QT_VERSION win64_msvc2019_64 --outputdir $env:USERPROFILE\Qt --modules qtcharts qtquickcontrols2 qtmultimedia

      - name: Configure & build
        shell: pwsh
        run: |
          cmake -S . -B $env:BUILD_DIR -G "Visual Studio 17 2022" -DCMAKE_PREFIX_PATH="$env:USERPROFILE\Qt\${env:QT_VERSION}\msvc2019_64"
          cmake --build $env:BUILD_DIR --config Release

      - name: Run windeployqt
        shell: pwsh
        run: |
          $qtbin = "$env:USERPROFILE\Qt\${env:QT_VERSION}\msvc2019_64\bin"
          & "$qtbin\windeployqt.exe" "$env:BUILD_DIR/Release/appproject-overwatch.exe" --qmldir="$PWD"

      - name: Prepare installer files directory
        shell: pwsh
        run: |
          rm -Recurse -Force $env:INSTALLER_SRC -ErrorAction Ignore
          mkdir $env:INSTALLER_SRC
          Copy-Item "$env:BUILD_DIR/Release/*" $env:INSTALLER_SRC -Recurse

      - name: Install NSIS
        uses: crazy-max/ghaction-chocolatey@v2
        with:
          args: install nsis

      - name: Build installer (NSIS)
        shell: pwsh
        run: |
          makensis.exe installer.nsi

      - name: Upload Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: appproject-overwatch-installer
          path: appproject-overwatch-setup.exe

