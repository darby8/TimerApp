name: Windows Qt Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    env:
      QT_VERSION: 6.8.3
      QT_DIR: ${{ runner.temp }}/Qt
      BUILD_DIR: build
      APP_NAME: appproject-overwatch.exe

    steps:
      - name: Checkout repository (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Python & aqt
        shell: cmd
        run: |
          python -m pip install --upgrade pip
          pip install aqtinstall==3.3.0

      - name: Install Qt 6.8.3 MSVC 2022
        shell: cmd
        run: |
          aqt install-qt windows desktop %QT_VERSION% win64_msvc2022_64 --outputdir "%QT_DIR%" --modules qtcharts qtmultimedia qtshadertools

      - name: Set Qt Environment Vars
        shell: cmd
        run: |
          echo QtBinPath=%QT_DIR%\%QT_VERSION%\msvc2022_64\bin>> %GITHUB_ENV%
          echo CMAKE_PREFIX_PATH=%QT_DIR%\%QT_VERSION%\msvc2022_64>> %GITHUB_ENV%

      - name: Remove MinGW from PATH
        shell: cmd
        run: |
          setx PATH "%PATH:mingw=%"

      - name: Configure CMake (MSVC)
        shell: cmd
        run: |
          cmake -S . -B %BUILD_DIR% -G "Visual Studio 17 2022" -A x64 -DCMAKE_PREFIX_PATH="%CMAKE_PREFIX_PATH%"

      - name: Build Release
        shell: cmd
        run: |
          cmake --build %BUILD_DIR% --config Release

      - name: Deploy Qt (windeployqt)
        shell: cmd
        run: |
          "%QtBinPath%\windeployqt.exe" "%BUILD_DIR%\Release\%APP_NAME%" --release --qmldir .

      - name: Package ZIP
        shell: cmd
        run: |
          cd %BUILD_DIR%\Release
          powershell Compress-Archive -Path * -DestinationPath "%GITHUB_WORKSPACE%\appproject-overwatch.zip"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: appproject-overwatch-windows
          path: appproject-overwatch.zip

