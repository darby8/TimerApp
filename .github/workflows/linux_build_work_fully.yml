name: Linux Qt Build (project-overwatch)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  linux-build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:20.04

    env:
      QT_VERSION: 6.5.3
      BUILD_DIR: build
      APP_NAME: appproject-overwatch
      APP_DIR: AppDir
      PACKAGE_NAME: project-overwatch
      PACKAGE_VERSION: "1.0.0"
      ARCH: amd64

    steps:
      # Install Git
      - name: Install Git
        run: |
          apt-get update
          apt-get install -y software-properties-common
          add-apt-repository ppa:git-core/ppa -y
          apt-get update
          apt-get install -y git

      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # Prepare environment (disable tzdata prompts)
      - name: Prepare environment
        run: |
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y tzdata locales
          locale-gen en_US.UTF-8
          update-locale LANG=en_US.UTF-8

      # Install base dependencies
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            patchelf \
            wget \
            curl \
            imagemagick \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libegl1-mesa-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev \
            libglib2.0-0 libglib2.0-dev \
            libdbus-1-dev \
            libfontconfig1-dev \
            libxcb-cursor0 libxcb-xinerama0 libxcb-util1 libx11-xcb1 \
            libxrender1 libxrandr2 libegl1 libglu1-mesa \
            libxcb-render-util0 libxcb-render0 libxcb-image0 libxcb-keysyms1 \
            libxcb-icccm4 libxcb-shape0 libxcb-xfixes0 libxcb-sync1 \
            libxcb-randr0 libxcb-xinerama0 libxcb-cursor0 libxcb1-dev \
            libx11-xcb-dev \
            libxkbfile-dev \
            libxtst-dev \
            libxt-dev \
            libxinerama-dev

      # Install database libraries
      - name: Install PostgreSQL/MySQL/ODBC libraries
        run: |
          apt-get install -y libpq-dev libpq5 libmysqlclient-dev \
            unixodbc unixodbc-dev odbcinst odbcinst1debian2

      # Install Python & aqtinstall
      - name: Install Python & aqt
        run: |
          apt-get install -y python3 python3-pip
          pip3 install --upgrade pip
          pip3 install aqtinstall==3.1.18

      # Install Qt 6.5.3
      - name: Install Qt ${{ env.QT_VERSION }}
        run: |
          python3 -m aqt install-qt linux desktop $QT_VERSION gcc_64 \
            --outputdir Qt \
            --modules qtcharts qtmultimedia qtshadertools qtpositioning qtwebchannel qtwebengine qtwebview qtserialport
          echo "CMAKE_PREFIX_PATH=$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64" >> $GITHUB_ENV

      # Configure CMake
      - name: Configure CMake
        run: |
          cmake -S . -B $BUILD_DIR -G Ninja \
            -DCMAKE_PREFIX_PATH="$CMAKE_PREFIX_PATH" \
            -DCMAKE_BUILD_TYPE=Release

      # Build project
      - name: Build Project
        run: cmake --build $BUILD_DIR --config Release --parallel

      # Detect built executable
      - name: Detect executable
        id: findexe
        run: |
          EXE=$(find $BUILD_DIR -maxdepth 3 -type f -executable -name "$APP_NAME*" | head -n 1)
          if [ -z "$EXE" ]; then
            echo "No executable matching $APP_NAME found in $BUILD_DIR"
            exit 1
          fi
          echo "EXE=$EXE" >> $GITHUB_ENV
          echo "Found executable: $EXE"

      # Prepare packaging tools
      - name: Install packaging utilities
        run: |
          apt-get update
          apt-get install -y fakeroot dpkg-dev dh-make debhelper

      # Prepare deb package layout
      - name: Create DEB package layout
        run: |
          set -e
          PKG_DIR=${GITHUB_WORKSPACE}/deb_build
          rm -rf "$PKG_DIR"
          mkdir -p "$PKG_DIR/DEBIAN"
          mkdir -p "$PKG_DIR/opt/${PACKAGE_NAME}"
          mkdir -p "$PKG_DIR/usr/bin"
          mkdir -p "$PKG_DIR/usr/share/applications"
          mkdir -p "$PKG_DIR/usr/share/icons/hicolor/256x256/apps"

          # Copy executable into /opt/<package>
          cp "$EXE" "$PKG_DIR/opt/${PACKAGE_NAME}/${PACKAGE_NAME}"
          chmod 755 "$PKG_DIR/opt/${PACKAGE_NAME}/${PACKAGE_NAME}"

          # Create launcher symlink at postinst (do not create here)
          # Create .desktop file (Exec points to /usr/bin/<binary>)
          cat > "$PKG_DIR/usr/share/applications/${PACKAGE_NAME}.desktop" <<EOF
          [Desktop Entry]
          Type=Application
          Name=Project Overwatch
          Exec=/usr/bin/${PACKAGE_NAME}
          Icon=${PACKAGE_NAME}
          Terminal=false
          Categories=Utility;
          EOF

          # Icon: if you have icons/ in repo, use it; otherwise create placeholder
          if [ -f icons/${PACKAGE_NAME}.png ]; then
            cp icons/${PACKAGE_NAME}.png "$PKG_DIR/usr/share/icons/hicolor/256x256/apps/${PACKAGE_NAME}.png"
          else
            convert -size 256x256 xc:none "$PKG_DIR/usr/share/icons/hicolor/256x256/apps/${PACKAGE_NAME}.png" || touch "$PKG_DIR/usr/share/icons/hicolor/256x256/apps/${PACKAGE_NAME}.png"
          fi

          # Create DEBIAN/control
          cat > "$PKG_DIR/DEBIAN/control" <<EOF
          Package: ${PACKAGE_NAME}
          Version: ${PACKAGE_VERSION}
          Section: utils
          Priority: optional
          Architecture: ${ARCH}
          Maintainer: Your Name <you@example.com>
          Description: Project Overwatch - Qt-based monitoring application
          Depends: libglib2.0-0
          EOF

          # Create DEBIAN/postinst (create symlink and update icon cache)
          cat > "$PKG_DIR/DEBIAN/postinst" <<'POSTINST'
          #!/bin/sh
          set -e
          # create symlink to /usr/bin
          ln -sf /opt/project-overwatch/project-overwatch /usr/bin/project-overwatch
          chmod +x /opt/project-overwatch/project-overwatch || true
          # update icon cache if available
          if command -v gtk-update-icon-cache >/dev/null 2>&1; then
            gtk-update-icon-cache -f /usr/share/icons/hicolor || true
          fi
          # update desktop database if available
          if command -v update-desktop-database >/dev/null 2>&1; then
            update-desktop-database || true
          fi
          exit 0
          POSTINST
          chmod 755 "$PKG_DIR/DEBIAN/postinst"

          # Create DEBIAN/prerm (remove symlink)
          cat > "$PKG_DIR/DEBIAN/prerm" <<'PRERM'
          #!/bin/sh
          set -e
          if [ -L /usr/bin/project-overwatch ]; then
            rm -f /usr/bin/project-overwatch
          fi
          exit 0
          PRERM
          chmod 755 "$PKG_DIR/DEBIAN/prerm"

          # Ensure ownership and permissions are correct
          find "$PKG_DIR" -type d -exec chmod 755 {} \;
          find "$PKG_DIR" -type f -exec chmod 644 {} \;
          chmod 755 "$PKG_DIR/opt/${PACKAGE_NAME}/${PACKAGE_NAME}"


      - name: Fix .deb package permissions
        run: |
          PKG_DIR=${GITHUB_WORKSPACE}/deb_build

          echo "Fixing directory permissions..."
          find "$PKG_DIR" -type d -exec chmod 755 {} \;

    	  echo "Fixing file permissions except maintainer scripts..."
    	  find "$PKG_DIR" -type f ! -name postinst ! -name prerm -exec chmod 644 {} \;

	  echo "Making maintainer scripts executable..."
	  chmod 755 "$PKG_DIR/DEBIAN/postinst"
	  chmod 755 "$PKG_DIR/DEBIAN/prerm"

	  echo "Making main binary executable..."
	  chmod 755 "$PKG_DIR/opt/${PACKAGE_NAME}/${PACKAGE_NAME}"





      - name: Build .deb
        run: |
          set -e
          PKG_DIR=${GITHUB_WORKSPACE}/deb_build
          OUTPUT_DEB=${GITHUB_WORKSPACE}/${PACKAGE_NAME}_${PACKAGE_VERSION}_${ARCH}.deb
          fakeroot dpkg-deb --build "$PKG_DIR" "$OUTPUT_DEB"
          ls -lah "$OUTPUT_DEB"
          echo "DEB=$OUTPUT_DEB" >> $GITHUB_ENV
          
          

      # Run a quick lintian check (optional)
      - name: Lint .deb (optional)
        run: |
          apt-get update
          apt-get install -y lintian || true
          if [ -f "${DEB:-$GITHUB_WORKSPACE}/${PACKAGE_NAME}_${PACKAGE_VERSION}_${ARCH}.deb" ]; then
            lintian --info --display-experimental "${GITHUB_WORKSPACE}/${PACKAGE_NAME}_${PACKAGE_VERSION}_${ARCH}.deb" || true
          else
            lintian --info --display-experimental "${PACKAGE_NAME}_${PACKAGE_VERSION}_${ARCH}.deb" || true
          fi

      # Upload .deb artifact
      - name: Upload .deb
        uses: actions/upload-artifact@v4
        with:
          name: project-overwatch-deb
          path: "${PACKAGE_NAME}_${PACKAGE_VERSION}_${ARCH}.deb"

