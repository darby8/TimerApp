name: Linux Qt Build (project-overwatch)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  linux-build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:20.04

    env:
      QT_VERSION: 6.5.3
      BUILD_DIR: build
      APP_NAME: appproject-overwatch
      PACKAGE_NAME: project-overwatch
      PACKAGE_VERSION: "1.0.0"
      ARCH: amd64
      QT_INSTALL_DIR: ${{ github.workspace }}/Qt/${{ env.QT_VERSION }}/gcc_64
      DEB_DIR: ${{ github.workspace }}/deb_build
      OUT_DEB: ${{ github.workspace }}/${{ env.PACKAGE_NAME }}_${{ env.PACKAGE_VERSION }}_${{ env.ARCH }}.deb

    steps:
      - name: Install Git
        run: |
          apt-get update
          apt-get install -y software-properties-common
          add-apt-repository ppa:git-core/ppa -y
          apt-get update
          apt-get install -y git

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Prepare environment
        run: |
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y tzdata locales
          locale-gen en_US.UTF-8
          update-locale LANG=en_US.UTF-8

      - name: Install base dependencies
        run: |
          apt-get update
          apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            patchelf \
            wget \
            curl \
            imagemagick \
            binutils \
            file \
            lsb-release \
            ca-certificates \
            xz-utils \
            python3 \
            python3-pip

      - name: Install packaging utilities
        run: |
          apt-get update
          apt-get install -y fakeroot dpkg-dev dh-make debhelper

      - name: Install aqtinstall
        run: |
          pip3 install --upgrade pip
          pip3 install aqtinstall==3.1.18

      - name: Install Qt ${{ env.QT_VERSION }}
        run: |
          python3 -m aqt install-qt linux desktop $QT_VERSION gcc_64 \
            --outputdir Qt \
            --modules qtcharts qtmultimedia qtshadertools qtpositioning qtwebchannel qtwebengine qtwebview qtserialport
          echo "Qt installed to $QT_INSTALL_DIR"
          ls -lah "$QT_INSTALL_DIR" || true

      - name: Configure CMake
        run: |
          cmake -S . -B $BUILD_DIR -G Ninja \
            -DCMAKE_PREFIX_PATH="${QT_INSTALL_DIR}" \
            -DCMAKE_BUILD_TYPE=Release

      - name: Build Project
        run: cmake --build $BUILD_DIR --config Release --parallel

      - name: Detect executable
        id: findexe
        run: |
          EXE=$(find $BUILD_DIR -maxdepth 4 -type f -executable -name "${APP_NAME}*" | head -n 1)
          if [ -z "$EXE" ]; then
            echo "No executable matching ${APP_NAME} found in ${BUILD_DIR}"
            exit 1
          fi
          echo "Found executable: $EXE"
          echo "EXE=$EXE" >> $GITHUB_ENV
          ls -lah "$EXE"

      - name: Prepare deb build layout
        run: |
          set -e
          PKG_DIR="${DEB_DIR}"
          rm -rf "$PKG_DIR"
          mkdir -p "$PKG_DIR/DEBIAN"
          mkdir -p "$PKG_DIR/opt/${PACKAGE_NAME}/bin"
          mkdir -p "$PKG_DIR/opt/${PACKAGE_NAME}/lib"
          mkdir -p "$PKG_DIR/opt/${PACKAGE_NAME}/plugins"
          mkdir -p "$PKG_DIR/opt/${PACKAGE_NAME}/qml"
          mkdir -p "$PKG_DIR/opt/${PACKAGE_NAME}/libexec"
          mkdir -p "$PKG_DIR/usr/share/applications"
          mkdir -p "$PKG_DIR/usr/share/icons/hicolor/256x256/apps"

          # Copy binary
          cp "$EXE" "$PKG_DIR/opt/${PACKAGE_NAME}/bin/${PACKAGE_NAME}"
          chmod 755 "$PKG_DIR/opt/${PACKAGE_NAME}/bin/${PACKAGE_NAME}"

      - name: Bundle Qt runtime (libs, plugins, qml, libexec)
        run: |
          set -e
          PKG_DIR="${DEB_DIR}"
          QT_DIR="${QT_INSTALL_DIR}"

          echo "QT_DIR = $QT_DIR"
          # Copy Qt libraries
          rsync -a --delete "${QT_DIR}/lib/" "${PKG_DIR}/opt/${PACKAGE_NAME}/lib/" || true

          # Copy plugins
          rsync -a --delete "${QT_DIR}/plugins/" "${PKG_DIR}/opt/${PACKAGE_NAME}/plugins/" || true

          # Copy qml modules
          if [ -d "${QT_DIR}/qml" ]; then
            rsync -a --delete "${QT_DIR}/qml/" "${PKG_DIR}/opt/${PACKAGE_NAME}/qml/" || true
          fi

          # Copy libexec (eg. QtWebEngineProcess)
          if [ -d "${QT_DIR}/libexec" ]; then
            rsync -a --delete "${QT_DIR}/libexec/" "${PKG_DIR}/opt/${PACKAGE_NAME}/libexec/" || true
          fi

          # Optional translations, icu, resources if present
          for d in "${QT_DIR}/translations" "${QT_DIR}/resources"; do
            if [ -d "$d" ]; then
              rsync -a "$d" "${PKG_DIR}/opt/${PACKAGE_NAME}/" || true
            fi
          done

          # Symlink top-level lib into bin's parent for $ORIGIN usage (we will use patchelf)
          echo "Bundled Qt content sizes:"
          du -sh "${PKG_DIR}/opt/${PACKAGE_NAME}" || true

      - name: Patch rpath for executables and helper processes
        run: |
          set -e
          PKG_DIR="${DEB_DIR}"
          APP_BIN="${PKG_DIR}/opt/${PACKAGE_NAME}/bin/${PACKAGE_NAME}"
          # Set rpath to use ./../lib relative to bin
          if command -v patchelf >/dev/null 2>&1; then
            patchelf --set-rpath '$ORIGIN/../lib' "$APP_BIN"
          fi

          # Also set rpath for QtWebEngineProcess (if exists)
          WEBENGINE_PROC=$(find "${PKG_DIR}/opt/${PACKAGE_NAME}/libexec" -type f -name "QtWebEngineProcess" -print -quit || true)
          if [ -n "$WEBENGINE_PROC" ]; then
            if command -v patchelf >/dev/null 2>&1; then
              patchelf --set-rpath '$ORIGIN/../lib' "$WEBENGINE_PROC" || true
            fi
          fi

          # As an extra safety, set rpath for any ELF files inside libexec and bin
          find "${PKG_DIR}/opt/${PACKAGE_NAME}" -type f -executable -print0 | xargs -0 file | grep ELF | cut -d: -f1 | while read -r f; do
            if command -v patchelf >/dev/null 2>&1; then
              patchelf --set-rpath '$ORIGIN/../lib' "$f" || true
            fi
          done || true

      - name: Create desktop file & icon
        run: |
          set -e
          PKG_DIR="${DEB_DIR}"
          # Desktop entry
          cat > "$PKG_DIR/usr/share/applications/${PACKAGE_NAME}.desktop" <<EOF
          [Desktop Entry]
          Name=Project Overwatch
          Exec=/opt/${PACKAGE_NAME}/bin/${PACKAGE_NAME}
          Icon=${PACKAGE_NAME}
          Type=Application
          Categories=Utility;
          Terminal=false
          EOF

          # Icon: copy from repo if exists, otherwise create placeholder
          if [ -f icons/${PACKAGE_NAME}.png ]; then
            cp icons/${PACKAGE_NAME}.png "$PKG_DIR/usr/share/icons/hicolor/256x256/apps/${PACKAGE_NAME}.png"
          else
            convert -size 256x256 xc:none "$PKG_DIR/usr/share/icons/hicolor/256x256/apps/${PACKAGE_NAME}.png" || touch "$PKG_DIR/usr/share/icons/hicolor/256x256/apps/${PACKAGE_NAME}.png"
          fi

      - name: Create DEBIAN control and maintainer scripts
        run: |
          set -e
          PKG_DIR="${DEB_DIR}"
          cat > "$PKG_DIR/DEBIAN/control" <<EOF
          Package: ${PACKAGE_NAME}
          Version: ${PACKAGE_VERSION}
          Section: utils
          Priority: optional
          Architecture: ${ARCH}
          Maintainer: Your Name <you@example.com>
          Description: Project Overwatch - Qt-based monitoring application
          EOF

          # postinst: create symlink and update caches
          cat > "$PKG_DIR/DEBIAN/postinst" <<'POSTINST'
          #!/bin/sh
          set -e
          # Create symlink
          ln -sf /opt/project-overwatch/bin/project-overwatch /usr/bin/project-overwatch
          chmod +x /opt/project-overwatch/bin/project-overwatch || true
          # Update icon cache and desktop db if available
          if command -v gtk-update-icon-cache >/dev/null 2>&1; then
            gtk-update-icon-cache -f /usr/share/icons/hicolor || true
          fi
          if command -v update-desktop-database >/dev/null 2>&1; then
            update-desktop-database || true
          fi
          exit 0
          POSTINST
          chmod 755 "$PKG_DIR/DEBIAN/postinst"

          # prerm: remove symlink
          cat > "$PKG_DIR/DEBIAN/prerm" <<'PRERM'
          #!/bin/sh
          set -e
          if [ -L /usr/bin/project-overwatch ]; then
            rm -f /usr/bin/project-overwatch
          fi
          exit 0
          PRERM
          chmod 755 "$PKG_DIR/DEBIAN/prerm"

      - name: Fix permissions (directories and files)
        run: |
          PKG_DIR="${DEB_DIR}"
          echo "Fixing permissions..."
          find "$PKG_DIR" -type d -exec chmod 755 {} \;
          # set regular files to 644 but exclude maintainer scripts
          find "$PKG_DIR" -type f ! -path "$PKG_DIR/DEBIAN/postinst" ! -path "$PKG_DIR/DEBIAN/prerm" -exec chmod 644 {} \;
          chmod 755 "$PKG_DIR/DEBIAN/postinst" "$PKG_DIR/DEBIAN/prerm"
          chmod 755 "$PKG_DIR/opt/${PACKAGE_NAME}/bin/${PACKAGE_NAME}"

      - name: Build .deb
        run: |
          set -e
          PKG_DIR="${DEB_DIR}"
          OUTPUT_DEB="${OUT_DEB}"
          echo "Building DEB at $OUTPUT_DEB ..."
          fakeroot dpkg-deb --build "$PKG_DIR" "$OUTPUT_DEB"
          ls -lah "$OUTPUT_DEB"
          echo "DEB=${OUTPUT_DEB}" >> $GITHUB_ENV

      - name: Lint .deb (optional)
        run: |
          apt-get update
          apt-get install -y lintian || true
          if [ -f "${OUT_DEB}" ]; then
            lintian --info --display-experimental "${OUT_DEB}" || true
          fi

      - name: Debug: list deb contents (optional)
        run: |
          if [ -f "${OUT_DEB}" ]; then
            echo "Deb file size:"
            ls -lh "${OUT_DEB}"
            echo "Listing archive members (first 50 lines):"
            dpkg-deb -c "${OUT_DEB}" | sed -n '1,50p'
          else
            echo "No deb produced!"
            ls -lah
            exit 1
          fi

      - name: Upload .deb package
        uses: actions/upload-artifact@v4
        with:
          name: project-overwatch-deb
          path: ${{ env.DEB }}

