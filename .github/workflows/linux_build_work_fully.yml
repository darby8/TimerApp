name: Linux Qt Build (project-overwatch)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  linux-build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:20.04

    env:
      QT_VERSION: 6.5.3
      BUILD_DIR: build
      APP_NAME: appproject-overwatch # Executable name and Icon name
      APP_DIR: AppDir
      APPIMAGE_EXTRACT_AND_RUN: 1
      PACKAGE_NAME: Project Overwatch # User-facing name

    steps:
      # ‚úÖ Install Git 2.40+ to avoid REST API fallback
      - name: Install Git
        run: |
          apt-get update
          apt-get install -y software-properties-common
          add-apt-repository ppa:git-core/ppa -y
          apt-get update
          apt-get install -y git

      # ‚úÖ Checkout repository with submodules
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # ‚úÖ Prepare environment (disable tzdata prompts)
      - name: Prepare environment
        run: |
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y tzdata locales
          locale-gen en_US.UTF-8
          update-locale LANG=en_US.UTF-8

      # ‚úÖ Install base dependencies
      - name: Install dependencies
        run: |
          apt-get install -y \
            build-essential cmake ninja-build patchelf wget curl imagemagick \
            libgl1-mesa-dev libglu1-mesa-dev libegl1-mesa-dev \
            libxkbcommon-dev libxkbcommon-x11-dev \
            libglib2.0-0 libglib2.0-dev libdbus-1-dev libfontconfig1-dev \
            libxcb-cursor0 libxcb-xinerama0 libxcb-util1 libx11-xcb1 \
            libxrender1 libxrandr2 libegl1 libglu1-mesa \
            libxcb-render-util0 libxcb-render0 libxcb-image0 libxcb-keysyms1 \
            libxcb-icccm4 libxcb-shape0 libxcb-xfixes0 libxcb-sync1 \
            libxcb-randr0 libxcb-xinerama0 libxcb-cursor0 libxcb1-dev \
            libx11-xcb-dev libxkbfile-dev libxtst-dev libxt-dev libxinerama-dev

      # ‚úÖ Install database libraries
      - name: Install database libraries
        run: |
          apt-get install -y libpq-dev libpq5 libmysqlclient-dev \
            unixodbc unixodbc-dev odbcinst odbcinst1debian2

      # ‚úÖ Install Python & aqtinstall
      - name: Install Python & aqt
        run: |
          apt-get install -y python3 python3-pip
          pip3 install --upgrade pip
          pip3 install aqtinstall==3.1.18

      # ‚úÖ Install Qt 6.5.3
      - name: Install Qt ${{ env.QT_VERSION }}
        run: |
          python3 -m aqt install-qt linux desktop $QT_VERSION gcc_64 \
            --outputdir Qt \
            --modules qtcharts qtmultimedia qtshadertools qtpositioning qtwebchannel qtwebengine qtwebview qtserialport
          echo "CMAKE_PREFIX_PATH=$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64" >> $GITHUB_ENV

      # ‚úÖ Configure CMake
      - name: Configure CMake
        run: |
          cmake -S . -B $BUILD_DIR -G Ninja \
            -DCMAKE_PREFIX_PATH="$CMAKE_PREFIX_PATH" \
            -DCMAKE_BUILD_TYPE=Release

      # ‚úÖ Build project
      - name: Build Project
        run: cmake --build $BUILD_DIR --config Release --parallel

      # ‚úÖ Detect built executable
      - name: Detect executable
        id: findexe
        run: |
          EXE=$(find $BUILD_DIR -maxdepth 2 -type f -executable -name "$APP_NAME*" | head -n 1)
          echo "EXE=$EXE" >> $GITHUB_ENV
          echo "Found executable: $EXE"

      # ‚úÖ Create AppDir structure and handle icon/desktop file (required by linuxdeployqt)
      - name: Create AppDir
        run: |
          mkdir -p $APP_DIR/usr/bin $APP_DIR/usr/share/applications $APP_DIR/usr/share/icons/hicolor/256x256/apps
          cp "$EXE" $APP_DIR/usr/bin/$APP_NAME
          chmod +x $APP_DIR/usr/bin/$APP_NAME

          # Copy or create icon (used by linuxdeployqt and the final installer)
          if [ -f icons/$APP_NAME.png ]; then
            cp icons/$APP_NAME.png $APP_DIR/usr/share/icons/hicolor/256x256/apps/$APP_NAME.png
          else
            convert -size 256x256 xc:none $APP_DIR/usr/share/icons/hicolor/256x256/apps/$APP_NAME.png || touch $APP_DIR/usr/share/icons/hicolor/256x256/apps/$APP_NAME.png
          fi

          # Create desktop entry template for linuxdeployqt
          cat <<EOF > $APP_DIR/usr/share/applications/$APP_NAME.desktop
          [Desktop Entry]
          Name=${{ env.PACKAGE_NAME }}
          Exec=$APP_NAME
          Icon=$APP_NAME
          Type=Application
          Categories=Utility;
          EOF

      # ‚úÖ Download linuxdeployqt
      - name: Download linuxdeployqt
        run: |
          wget -q https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage -O linuxdeployqt
          chmod +x linuxdeployqt

      # ‚úÖ Install QtWebEngine runtime dependencies
      - name: Install QtWebEngine runtime dependencies
        run: |
          apt-get update
          apt-get install -y libnss3 libnspr4 libxss1 libasound2 libxcomposite1 libxdamage1

      # ‚úÖ Build AppImage
      - name: Build AppImage
        id: appimage
        run: |
          export PATH="$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64/bin:$PATH"
          export QML_IMPORT_PATH="$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64/qml"
          export QML2_IMPORT_PATH="$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64/qml"
          export QT_PLUGIN_PATH="$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64/plugins"

          ./linuxdeployqt \
            $APP_DIR/usr/share/applications/$APP_NAME.desktop \
            -qmldir="$GITHUB_WORKSPACE/QML" \
            -qmake=$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64/bin/qmake \
            -bundle-non-qt-libs \
            -appimage

          APPIMAGE=$(ls -1t *.AppImage | head -n 1)
          echo "APPIMAGE=$APPIMAGE" >> $GITHUB_ENV
          echo "‚úÖ Built AppImage: $APPIMAGE"

      # ‚úÖ Upload AppImage (for testing purposes)
      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: project-overwatch-Linux-AppImage
          path: "*.AppImage"

      - name: Prepare Qt Installer Framework structure
        run: |
          mkdir -p installer/input/config
          mkdir -p installer/input/packages/com.yourcompany.projectoverwatch/meta
          mkdir -p installer/input/packages/com.yourcompany.projectoverwatch/data

          echo "üß± Creating QtIFW config files..."

          # ‚úÖ Main installer configuration
          cat <<EOF > installer/input/config/config.xml
          <?xml version="1.0" encoding="UTF-8"?>
          <Installer>
              <Name>${{ env.PACKAGE_NAME }} Installer</Name>
              <Version>1.0.0</Version>
              <Title>${{ env.PACKAGE_NAME }}</Title>
              <Publisher>Your Company</Publisher>
              <StartMenuDir>${{ env.PACKAGE_NAME }}</StartMenuDir>
              <TargetDir>@HomeDir@/${{ env.PACKAGE_NAME }}</TargetDir>
              <RunProgram>@TargetDir@/${{ env.PACKAGE_NAME }}.AppImage</RunProgram>
          </Installer>
          EOF

          # ‚úÖ Package metadata
          cat <<EOF > installer/input/packages/com.yourcompany.projectoverwatch/meta/package.xml
          <?xml version="1.0" encoding="UTF-8"?>
          <Package>
              <DisplayName>${{ env.PACKAGE_NAME }}</DisplayName>
              <Description>Qt-based monitoring application</Description>
              <Version>1.0.0</Version>
              <ReleaseDate>2025-12-05</ReleaseDate>
              <Default>true</Default>
              <Script>installscript.qs</Script>
          </Package>
          EOF

          # ‚ö†Ô∏è UPDATED: The installscript.qs now includes desktop integration.
          cat <<'EOF' > installer/input/packages/com.yourcompany.projectoverwatch/meta/installscript.qs
          function Component() {}
          
          Component.prototype.createOperations = function() {
              component.createOperations();
              
              try {
                  var targetDir = installer.value("TargetDir");
                  var appPath = targetDir + "/project-overwatch.AppImage";
                  var appName = "appproject-overwatch"; 
                  
                  // 1. Make AppImage executable
                  component.addOperation("Execute", "/bin/chmod", "+x", appPath);

                  // 2. Setup standard user paths for desktop integration
                  var homeDir = installer.environmentVariable("HOME");
                  var iconTargetDir = homeDir + "/.local/share/icons/hicolor/256x256/apps";
                  var desktopTargetDir = homeDir + "/.local/share/applications";
                  
                  // 3. Define source/target file paths
                  var iconSource = installer.value("PackageDir") + "/data/" + appName + ".png";
                  var iconTarget = iconTargetDir + "/" + appName + ".png";
                  var desktopTarget = desktopTargetDir + "/" + appName + ".desktop";
                  
                  // 4. Create directories and copy the icon
                  component.addOperation("Mkdir", iconTargetDir);
                  component.addOperation("Copy", iconSource, iconTarget);
                  
                  // 5. Create the Desktop Entry file content
                  var desktopContent = "[Desktop Entry]\n" +
                      "Name=Project Overwatch\n" +
                      // Exec must point to the AppImage's final location
                      "Exec=\"" + appPath + "\"\n" +
                      "Icon=" + appName + "\n" +
                      "Type=Application\n" +
                      "Categories=Utility;\n";

                  component.addOperation("Create", desktopTarget, desktopContent);

                  // 6. Update the desktop database (essential for immediate menu visibility)
                  component.addOperation("Execute", "/usr/bin/update-desktop-database", desktopTargetDir);

              } catch (e) {
                  console.log("‚ùå Installer error during integration: " + e);
              }
          }
          
          // ‚úÖ Run app automatically after installation
          Component.prototype.installationFinished = function() {
              try {
                  var targetDir = installer.value("TargetDir");
                  var appPath = targetDir + "/project-overwatch.AppImage";
                  QProcess.startDetached(appPath, []);
              } catch (e) {
                  console.log("‚ö†Ô∏è Failed to auto-run app: " + e);
              }
          }
          EOF

      # ‚úÖ Copy AppImage and Icon into the Installer's package data
      - name: Copy AppImage and Icon for Installer Package
        run: |
          PKG_DATA_DIR=installer/input/packages/com.yourcompany.projectoverwatch/data
          APP_NAME_ENV=${{ env.APP_NAME }} # appproject-overwatch

          # Copy AppImage and rename consistently
          APPFILE=$(ls -1t *.AppImage | head -n 1)
          if [ -f "$APPFILE" ]; then
            cp "$APPFILE" $PKG_DATA_DIR/project-overwatch.AppImage
            echo "‚úÖ Copied $APPFILE -> project-overwatch.AppImage"
          else
            echo "‚ö†Ô∏è No AppImage found!"
            exit 1
          fi
          
          # Copy the icon
          ICON_SOURCE=$APP_DIR/usr/share/icons/hicolor/256x256/apps/${APP_NAME_ENV}.png
          if [ -f "$ICON_SOURCE" ]; then
              cp "$ICON_SOURCE" $PKG_DATA_DIR/${APP_NAME_ENV}.png
              echo "‚úÖ Copied icon into IFW package data."
          else
              echo "‚ùå Icon file not found, desktop entry may not have an icon!"
          fi


      - name: Install Qt Installer Framework (QtIFW)
        run: |
          # Use aqt to install the IFW tools
          pip install aqtinstall==3.1.18 --root-user-action=ignore
          IFW_VERSION=$(python3 -m aqt list-tool linux desktop tools_ifw | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | tail -n 1 || echo "4.6.1")
          echo "Detected IFW version: $IFW_VERSION"
          python3 -m aqt install-tool linux desktop tools_ifw $IFW_VERSION --outputdir QtIFW || \
          python3 -m aqt install-tool linux desktop tools_ifw 4.6.1 --outputdir QtIFW

      # ‚úÖ Detect binarycreator automatically
      - name: Fix IFW path detection
        run: |
          echo "üîç Searching for binarycreator..."
          IFW_PATH=$(find "$GITHUB_WORKSPACE/QtIFW" -type f -name binarycreator -exec dirname {} \; | head -n 1)
          if [ -z "$IFW_PATH" ]; then
            echo "‚ùå binarycreator not found under QtIFW folder!"
            exit 1
          fi
          echo "‚úÖ Found binarycreator at: $IFW_PATH"
          echo "IFW_PATH=$IFW_PATH" >> $GITHUB_ENV


      # ‚úÖ Build GUI Installer (.run file)
      - name: Build GUI Installer
        run: |
          $IFW_PATH/binarycreator \
            -c installer/input/config/config.xml \
            -p installer/input/packages \
            project-overwatch-installer.run

      # ‚úÖ Upload GUI Installer
      - name: Upload GUI Installer
        uses: actions/upload-artifact@v4
        with:
          name: project-overwatch-GUI-Installer
          path: project-overwatch-installer.run
