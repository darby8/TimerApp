name: Linux Qt Build (project-overwatch)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  linux-build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:20.04

    env:
      QT_VERSION: 6.5.3
      BUILD_DIR: build
      APP_NAME: overwatch
      INSTALL_DIR: /opt/project-overwatch
      ICON_NAME: overwatch.png

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y build-essential cmake ninja-build wget curl \
            libgl1-mesa-dev libglu1-mesa-dev libegl1-mesa-dev \
            libxkbcommon-dev libxkbcommon-x11-dev libxcb1-dev \
            libx11-xcb-dev libxtst-dev libxt-dev libxinerama-dev \
            libglib2.0-0 libglib2.0-dev imagemagick python3 python3-pip
          pip3 install --upgrade pip
          pip3 install aqtinstall==3.1.18

      - name: Install Qt
        run: |
          python3 -m aqt install-qt linux desktop $QT_VERSION gcc_64 \
            --outputdir Qt \
            --modules qtcharts qtmultimedia qtwebengine qtserialport
          echo "CMAKE_PREFIX_PATH=$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64" >> $GITHUB_ENV

      - name: Configure CMake
        run: |
          cmake -S . -B $BUILD_DIR -G Ninja \
            -DCMAKE_PREFIX_PATH="$CMAKE_PREFIX_PATH" \
            -DCMAKE_BUILD_TYPE=Release

      - name: Build Project
        run: cmake --build $BUILD_DIR --parallel

      - name: Detect Executable
        run: |
          EXE=$(find $BUILD_DIR -type f -executable -name "$APP_NAME*" | head -n 1)
          echo "EXE=$EXE" >> $GITHUB_ENV
          echo "Executable: $EXE"

      - name: Create AppDir structure
        run: |
          mkdir -p $INSTALL_DIR/bin $INSTALL_DIR/lib $INSTALL_DIR/plugins $INSTALL_DIR/qml $INSTALL_DIR/icons
          cp "$EXE" $INSTALL_DIR/bin/$APP_NAME
          chmod +x $INSTALL_DIR/bin/$APP_NAME

      - name: Copy Qt libraries & plugins
        run: |
          QT_DIR=$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64
          cp -r $QT_DIR/lib/* $INSTALL_DIR/lib/
          cp -r $QT_DIR/plugins/* $INSTALL_DIR/plugins/
          cp -r $QT_DIR/qml/* $INSTALL_DIR/qml/

      - name: Create wrapper script
        run: |
          cat <<EOF > $INSTALL_DIR/bin/run-$APP_NAME.sh
          #!/bin/bash
          export LD_LIBRARY_PATH=$INSTALL_DIR/lib:\$LD_LIBRARY_PATH
          export QT_PLUGIN_PATH=$INSTALL_DIR/plugins
          export QT_QPA_PLATFORM_PLUGIN_PATH=$INSTALL_DIR/plugins/platforms
          export QML2_IMPORT_PATH=$INSTALL_DIR/qml
          exec $INSTALL_DIR/bin/$APP_NAME "\$@"
          EOF
          chmod +x $INSTALL_DIR/bin/run-$APP_NAME.sh

      - name: Add icon
        run: |
          if [ -f icons/$ICON_NAME ]; then
            cp icons/$ICON_NAME $INSTALL_DIR/icons/$ICON_NAME
          else
            convert -size 256x256 xc:none $INSTALL_DIR/icons/$ICON_NAME
          fi

      - name: Create .desktop launcher
        run: |
          DESKTOP_FILE=$GITHUB_WORKSPACE/$APP_NAME.desktop
          cat <<EOF > $DESKTOP_FILE
          [Desktop Entry]
          Name=Project Overwatch
          Exec=$INSTALL_DIR/bin/run-$APP_NAME.sh
          Icon=$INSTALL_DIR/icons/$ICON_NAME
          Type=Application
          Terminal=false
          Categories=Utility;
          EOF

      - name: Upload AppDir & Desktop file
        uses: actions/upload-artifact@v4
        with:
          name: project-overwatch-AppDir
          path: |
            $INSTALL_DIR
            $GITHUB_WORKSPACE/$APP_NAME.desktop

