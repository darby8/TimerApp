name: Build Linux .deb (project-overwatch)
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-deb:
    runs-on: ubuntu-latest

    env:
      QT_VERSION: 6.5.3
      BUILD_DIR: build
      APP_NAME: appproject-overwatch
      PACKAGE_NAME: project-overwatch
      PACKAGE_VERSION: 1.0.0
      ARCH: amd64
      APP_INSTALL_DIR: /opt/project-overwatch

    steps:
      # Checkout repository
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # Install build dependencies
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y build-essential cmake ninja-build patchelf wget curl imagemagick \
            libgl1-mesa-dev libglu1-mesa-dev libegl1-mesa-dev \
            libxkbcommon-dev libxkbcommon-x11-dev libglib2.0-0 libglib2.0-dev \
            libdbus-1-dev libfontconfig1-dev libxcb1-dev libx11-xcb-dev \
            libxtst-dev libxinerama-dev python3 python3-pip fakeroot dpkg-dev

      # Install Qt
      - name: Install Qt
        run: |
          pip3 install --upgrade pip
          pip3 install aqtinstall==3.1.18
          python3 -m aqt install-qt linux desktop $QT_VERSION gcc_64 \
            --outputdir Qt \
            --modules qtcharts qtmultimedia qtpositioning qtwebchannel qtwebengine qtwebview qtserialport
          echo "CMAKE_PREFIX_PATH=$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64" >> $GITHUB_ENV

      # Configure CMake
      - name: Configure CMake
        run: |
          cmake -S . -B $BUILD_DIR -G Ninja \
            -DCMAKE_PREFIX_PATH="$CMAKE_PREFIX_PATH" \
            -DCMAKE_BUILD_TYPE=Release

      # Build
      - name: Build Project
        run: cmake --build $BUILD_DIR --config Release --parallel

      # Detect executable
      - name: Detect executable
        id: findexe
        run: |
          EXE=$(find $BUILD_DIR -maxdepth 2 -type f -executable -name "$APP_NAME*" | head -n 1)
          if [ -z "$EXE" ]; then
            echo "Executable not found!"
            exit 1
          fi
          echo "EXE=$EXE" >> $GITHUB_ENV

      # Prepare AppDir for packaging
      - name: Prepare AppDir
        run: |
          APPDIR=$GITHUB_WORKSPACE/AppDir
          mkdir -p $APPDIR/usr/bin $APPDIR/usr/share/applications $APPDIR/usr/share/icons/hicolor/256x256/apps
          cp "$EXE" $APPDIR/usr/bin/$APP_NAME
          chmod +x $APPDIR/usr/bin/$APP_NAME

          # Desktop entry
          cat <<EOF > $APPDIR/usr/share/applications/$APP_NAME.desktop
[Desktop Entry]
Name=Project Overwatch
Exec=$APP_NAME
Icon=project-overwatch
Type=Application
Categories=Utility;
EOF

          # Icon
          if [ -f icons/$APP_NAME.png ]; then
            cp icons/$APP_NAME.png $APPDIR/usr/share/icons/hicolor/256x256/apps/project-overwatch.png
          else
            convert -size 256x256 xc:none $APPDIR/usr/share/icons/hicolor/256x256/apps/project-overwatch.png || touch $APPDIR/usr/share/icons/hicolor/256x256/apps/project-overwatch.png
          fi

      # Download linuxdeployqt to bundle Qt libraries
      - name: Download linuxdeployqt
        run: |
          wget -q https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage -O linuxdeployqt
          chmod +x linuxdeployqt

      # Bundle Qt libraries into AppDir
      - name: Bundle Qt libraries
        run: |
          APPDIR=$GITHUB_WORKSPACE/AppDir
          ./linuxdeployqt \
            $APPDIR/usr/share/applications/$APP_NAME.desktop \
            -qmldir=$GITHUB_WORKSPACE/QML \
            -qmake=$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64/bin/qmake \
            -bundle-non-qt-libs

      # Create DEB structure
      - name: Create DEB package
        run: |
          PKG_DIR=$GITHUB_WORKSPACE/deb_build
          rm -rf "$PKG_DIR"
          mkdir -p "$PKG_DIR/DEBIAN" "$PKG_DIR$APP_INSTALL_DIR" "$PKG_DIR/usr/bin" "$PKG_DIR/usr/share/applications" "$PKG_DIR/usr/share/icons/hicolor/256x256/apps"

          # Copy AppDir contents
          cp -r $GITHUB_WORKSPACE/AppDir/usr/bin/* "$PKG_DIR$APP_INSTALL_DIR/"
          cp -r $GITHUB_WORKSPACE/AppDir/usr/share/applications/* "$PKG_DIR/usr/share/applications/"
          cp -r $GITHUB_WORKSPACE/AppDir/usr/share/icons/hicolor/256x256/apps/* "$PKG_DIR/usr/share/icons/hicolor/256x256/apps/"

          chmod -R 755 "$PKG_DIR$APP_INSTALL_DIR/$APP_NAME"

          # Postinst script
          cat <<'EOF' > "$PKG_DIR/DEBIAN/postinst"
#!/bin/sh
set -e
ln -sf /opt/project-overwatch/appproject-overwatch /usr/bin/appproject-overwatch
chmod +x /opt/project-overwatch/appproject-overwatch
update-desktop-database || true
exit 0
EOF

          # Prerm script
          cat <<'EOF' > "$PKG_DIR/DEBIAN/prerm"
#!/bin/sh
set -e
if [ -L /usr/bin/appproject-overwatch ]; then
  rm -f /usr/bin/appproject-overwatch
fi
exit 0
EOF

          chmod 755 "$PKG_DIR/DEBIAN/postinst" "$PKG_DIR/DEBIAN/prerm"

          # Control file
          cat <<EOF > "$PKG_DIR/DEBIAN/control"
Package: project-overwatch
Version: 1.0.0
Section: utils
Priority: optional
Architecture: amd64
Maintainer: Your Name <you@example.com>
Description: Project Overwatch - Qt-based monitoring application
Depends: libglib2.0-0, libglu1-mesa, libx11-6, libxcb1
EOF

      # Build .deb
      - name: Build .deb
        run: |
          OUTPUT_DEB=$GITHUB_WORKSPACE/project-overwatch_1.0.0_amd64.deb
          fakeroot dpkg-deb --build deb_build "$OUTPUT_DEB"
          echo "DEB=$OUTPUT_DEB" >> $GITHUB_ENV
          ls -lh "$OUTPUT_DEB"

      # Upload .deb artifact
      - name: Upload .deb
        uses: actions/upload-artifact@v4
        with:
          name: project-overwatch-deb
          path: ${{ env.DEB }}

