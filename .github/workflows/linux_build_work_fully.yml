name: Linux Qt Build (project-overwatch)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  linux-build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:20.04

    env:
      QT_VERSION: 6.5.3
      BUILD_DIR: build
      APP_NAME: appproject-overwatch
      APP_DIR: AppDir
      APPIMAGE_EXTRACT_AND_RUN: 1

    steps:
      - name: Install Git
        run: |
          apt-get update
          apt-get install -y git software-properties-common

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            build-essential cmake ninja-build patchelf wget curl imagemagick \
            libgl1-mesa-dev libegl1 libxkbcommon-dev libglib2.0-0 \
            libdbus-1-dev libfontconfig1-dev libxcb1-dev libx11-xcb-dev \
            libxrender1 libxrandr2 libxtst-dev libxt-dev libxinerama-dev \
            python3 python3-pip

      - name: Install aqt
        run: |
          pip3 install --upgrade pip
          pip3 install aqtinstall==3.1.18

      - name: Install Qt
        run: |
          python3 -m aqt install-qt linux desktop $QT_VERSION gcc_64 --outputdir Qt
          echo "CMAKE_PREFIX_PATH=$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64" >> $GITHUB_ENV

      - name: Configure
        run: |
          cmake -S . -B $BUILD_DIR -G Ninja \
            -DCMAKE_PREFIX_PATH="$CMAKE_PREFIX_PATH" \
            -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build $BUILD_DIR --parallel

      - name: Detect executable
        run: |
          EXE=$(find $BUILD_DIR -type f -executable | head -n 1)
          echo "EXE=$EXE" >> $GITHUB_ENV

      - name: Create AppDir
        run: |
          mkdir -p $APP_DIR/usr/bin $APP_DIR/usr/share/applications
          cp "$EXE" $APP_DIR/usr/bin/$APP_NAME
          chmod +x $APP_DIR/usr/bin/$APP_NAME

          cat <<EOF > $APP_DIR/usr/share/applications/$APP_NAME.desktop
          [Desktop Entry]
          Name=Project Overwatch
          Exec=$APP_NAME
          Icon=project-overwatch
          Type=Application
          Categories=Utility;
          EOF

      - name: Download linuxdeployqt
        run: |
          wget -q https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
          chmod +x linuxdeployqt-continuous-x86_64.AppImage

      - name: Build AppImage
        run: |
          export PATH="$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64/bin:$PATH"
          ./linuxdeployqt-continuous-x86_64.AppImage \
            $APP_DIR/usr/share/applications/$APP_NAME.desktop \
            -qmake=$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64/bin/qmake \
            -bundle-non-qt-libs \
            -appimage

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: project-overwatch-AppImage
          path: "*.AppImage"

# ================= SYSTEM-WIDE GUI INSTALLER =================

      - name: Prepare IFW Structure
        run: |
          mkdir -p installer/config
          mkdir -p installer/packages/com.overwatch/meta
          mkdir -p installer/packages/com.overwatch/data

          cat <<EOF > installer/config/config.xml
          <?xml version="1.0"?>
          <Installer>
              <Name>Project Overwatch</Name>
              <Version>1.0.0</Version>
              <Title>Project Overwatch</Title>
              <Publisher>Your Company</Publisher>
              <TargetDir>/opt/project-overwatch</TargetDir>
              <RunProgram>/opt/project-overwatch/project-overwatch.AppImage</RunProgram>
          </Installer>
          EOF

          cat <<EOF > installer/packages/com.overwatch/meta/package.xml
          <?xml version="1.0"?>
          <Package>
              <DisplayName>Project Overwatch</DisplayName>
              <Version>1.0.0</Version>
              <Default>true</Default>
          </Package>
          EOF

          APPIMAGE=$(ls *.AppImage | head -n 1)
          cp "$APPIMAGE" installer/packages/com.overwatch/data/project-overwatch.AppImage

          cat <<EOF > installer/packages/com.overwatch/data/project-overwatch.desktop
          [Desktop Entry]
          Name=Project Overwatch
          Exec=/opt/project-overwatch/project-overwatch.AppImage
          Type=Application
          Categories=Utility;
          Terminal=false
          EOF

      - name: Install Qt IFW (WORKING FIX)
        run: |
          python3 -m aqt install-tool linux desktop qt.tools.ifw.47 --outputdir QtIFW

      - name: Build GUI Installer
        run: |
          QtIFW/*/bin/binarycreator \
            -c installer/config/config.xml \
            -p installer/packages \
            project-overwatch-installer.run

      - name: Upload GUI Installer
        uses: actions/upload-artifact@v4
        with:
          name: project-overwatch-GUI-Installer
          path: project-overwatch-installer.run

