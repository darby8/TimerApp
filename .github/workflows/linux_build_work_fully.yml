---
name: 'Linux Qt Build (project-overwatch)'
'on':
  push:
    branches:
      - 'main'
  workflow_dispatch: null
jobs:
  linux-build:
    runs-on: 'ubuntu-latest'
    container:
      image: 'ubuntu:20.04'
      options: '--user root'
    env:
      QT_VERSION: '6.5.3'
      BUILD_DIR: 'build'
      APP_NAME: 'appproject-overwatch'
      APP_DIR: 'AppDir'
      APPIMAGE_EXTRACT_AND_RUN: 1
      PACKAGE_NAME: 'project-overwatch'
      PACKAGE_VERSION: '1.0.0'
      ARCH: 'amd64'
      APP_INSTALL_DIR: '/opt/project-overwatch'
    steps:
      - name: 'Install Git'
        run: "apt-get update\napt-get install -y software-properties-common\nadd-apt-repository ppa:git-core/ppa -y\napt-get update\napt-get install -y git\n"
      - name: 'Checkout repository'
        uses: 'actions/checkout@v4'
        with:
          submodules: 'recursive'
          fetch-depth: 0
      - name: 'Prepare environment'
        run: "export DEBIAN_FRONTEND=noninteractive\napt-get update\napt-get install -y tzdata locales\nlocale-gen en_US.UTF-8\nupdate-locale LANG=en_US.UTF-8\n"
      - name: 'Install dependencies'
        run: "apt-get install -y \\\n  build-essential cmake ninja-build patchelf wget curl imagemagick \\\n  libgl1-mesa-dev libglu1-mesa-dev libegl1-mesa-dev \\\n  libxkbcommon-dev libxkbcommon-x11-dev libglib2.0-0 libglib2.0-dev \\\n  libdbus-1-dev libfontconfig1-dev \\\n  libxcb-cursor0 libxcb-xinerama0 libxcb-util1 libx11-xcb1 \\\n  libxrender1 libxrandr2 libegl1 libglu1-mesa \\\n  libxcb-render-util0 libxcb-render0 libxcb-image0 libxcb-keysyms1 \\\n  libxcb-icccm4 libxcb-shape0 libxcb-xfixes0 libxcb-sync1 \\\n  libxcb-randr0 libxcb-xinerama0 libxcb-cursor0 libxcb1-dev \\\n  libx11-xcb-dev libxkbfile-dev libxtst-dev libxt-dev libxinerama-dev\n"
      - name: 'Install PostgreSQL/MySQL/ODBC libraries'
        run: "apt-get install -y libpq-dev libpq5 libmysqlclient-dev \\\n  unixodbc unixodbc-dev odbcinst odbcinst1debian2\n"
      - name: 'Install Python & aqt'
        run: "apt-get install -y python3 python3-pip\npip3 install --upgrade pip\npip3 install aqtinstall==3.1.18\n"
      - name: 'Install Qt ${{ env.QT_VERSION }}'
        run: "python3 -m aqt install-qt linux desktop $QT_VERSION gcc_64 \\\n  --outputdir Qt \\\n  --modules qtcharts qtmultimedia qtshadertools qtpositioning \\\n    qtwebchannel qtwebengine qtwebview qtserialport\necho \"CMAKE_PREFIX_PATH=$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64\" >> $GITHUB_ENV\n"
      - name: 'Configure CMake'
        run: "cmake -S . -B $BUILD_DIR -G Ninja \\\n  -DCMAKE_PREFIX_PATH=\"$CMAKE_PREFIX_PATH\" \\\n  -DCMAKE_BUILD_TYPE=Release\n"
      - name: 'Build Project'
        run: 'cmake --build $BUILD_DIR --config Release --parallel'
      - name: 'Detect executable'
        id: 'findexe'
        run: "EXE=$(find $BUILD_DIR -maxdepth 2 -type f -executable -name \"$APP_NAME*\" | head -n 1)\nif [ -z \"$EXE\" ]; then\n  echo \"Executable not found!\"\n  exit 1\nfi\necho \"EXE=$EXE\" >> $GITHUB_ENV\necho \"Found executable: $EXE\"\n"
      - name: 'Create DEB structure'
        run: "PKG_DIR=$GITHUB_WORKSPACE/deb_build\nrm -rf \"$PKG_DIR\"\nmkdir -p \"$PKG_DIR/DEBIAN\"\nmkdir -p \"$PKG_DIR$APP_INSTALL_DIR\"\nmkdir -p \"$PKG_DIR/usr/bin\"\nmkdir -p \"$PKG_DIR/usr/share/applications\"\nmkdir -p \"$PKG_DIR/usr/share/icons/hicolor/256x256/apps\"\n\ncp \"$EXE\" \"$PKG_DIR$APP_INSTALL_DIR/$APP_NAME\"\nchmod 755 \"$PKG_DIR$APP_INSTALL_DIR/$APP_NAME\"\n\n# Desktop file\ncat <<EOF > \"$PKG_DIR/usr/share/applications/$APP_NAME.desktop\"\n[Desktop Entry]\nName=Project Overwatch\nExec=/opt/project-overwatch/$APP_NAME\nType=Application\nIcon=project-overwatch\nCategories=Utility;\nEOF\n\n# Generate blank icon if missing\nconvert -size 256x256 xc:none \"$PKG_DIR/usr/share/icons/hicolor/256x256/apps/project-overwatch.png\"\n\n# Control file\ncat <<EOF > \"$PKG_DIR/DEBIAN/control\"\nPackage: project-overwatch\nVersion: 1.0.0\nSection: utils\nPriority: optional\nArchitecture: amd64\nMaintainer: Your Name <you@example.com>\nDescription: Project Overwatch Qt Application\nDepends: libglib2.0-0, libx11-6, libglu1-mesa\nEOF\n\n\ncat <<'EOF' > \"$PKG_DIR/DEBIAN/postinst\"\n\nset -e\nln -sf /opt/project-overwatch/appproject-overwatch /usr/bin/appproject-overwatch\nchmod +x /opt/project-overwatch/appproject-overwatch\nupdate-desktop-database || true\nexit 0\nEOF\n\nchmod 755 \"$PKG_DIR/DEBIAN/postinst\"\n"
      - name: 'Build .deb'
        run: "OUTPUT_DEB=$GITHUB_WORKSPACE/project-overwatch_1.0.0_amd64.deb\nfakeroot dpkg-deb --build deb_build \"$OUTPUT_DEB\"\necho \"DEB=$OUTPUT_DEB\" >> $GITHUB_ENV\nls -lh \"$OUTPUT_DEB\"\n"
      - name: 'Upload .deb artifact'
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'project-overwatch-deb'
          path: '${{ env.DEB }}'

