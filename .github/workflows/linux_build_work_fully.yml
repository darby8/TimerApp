name: Linux Qt Build (project-overwatch)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  linux-build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:20.04

    env:
      QT_VERSION: 6.5.3
      BUILD_DIR: build
      APP_NAME: appproject-overwatch
      INSTALL_DIR: /opt/project-overwatch
      PACKAGE_NAME: project-overwatch
      PACKAGE_VERSION: 1.0.0
      ARCH: amd64

    steps:

      - name: Install Git
        run: |
          apt-get update
          apt-get install -y software-properties-common
          add-apt-repository ppa:git-core/ppa -y
          apt-get update
          apt-get install -y git

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            build-essential cmake ninja-build \
            wget curl patchelf imagemagick \
            libgl1-mesa-dev libglu1-mesa-dev \
            libxkbcommon-x11-dev libxkbcommon-dev \
            libdbus-1-dev libfontconfig1-dev \
            libglib2.0-dev libglib2.0-0 \
            libnss3 libnspr4 libasound2 \
            libxss1 libxcomposite1 libxdamage1 \
            locales

      - name: Install Python & aqtinstall
        run: |
          apt-get install -y python3 python3-pip
          pip3 install --upgrade pip
          pip3 install aqtinstall==3.1.18

      - name: Install Qt ${{ env.QT_VERSION }}
        run: |
          python3 -m aqt install-qt linux desktop $QT_VERSION gcc_64 \
            --outputdir Qt \
            --modules qtcharts qtmultimedia qtshadertools qtpositioning qtwebchannel qtwebengine qtwebview qtserialport
          echo "CMAKE_PREFIX_PATH=$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64" >> $GITHUB_ENV

      - name: Configure CMake
        run: |
          cmake -S . -B $BUILD_DIR -G Ninja \
            -DCMAKE_PREFIX_PATH="$CMAKE_PREFIX_PATH" \
            -DCMAKE_BUILD_TYPE=Release

      - name: Build Project
        run: cmake --build $BUILD_DIR --config Release --parallel

      - name: Detect executable
        id: findexe
        run: |
          EXE=$(find $BUILD_DIR -maxdepth 2 -type f -executable -name "${APP_NAME}*" | head -n 1)
          echo "EXE=$EXE" >> $GITHUB_ENV
          echo "Executable: $EXE"

      # ---------------------------
      #  CREATE DEB PACKAGE
      # ---------------------------
      - name: Create DEB package structure
        run: |
          PKG_DIR=$GITHUB_WORKSPACE/deb_build
          mkdir -p $PKG_DIR/DEBIAN
          mkdir -p $PKG_DIR${INSTALL_DIR}/bin
          mkdir -p $PKG_DIR${INSTALL_DIR}/lib
          mkdir -p $PKG_DIR${INSTALL_DIR}/qml
          mkdir -p $PKG_DIR${INSTALL_DIR}/plugins
          mkdir -p $PKG_DIR/usr/share/applications
          mkdir -p $PKG_DIR/usr/share/icons/hicolor/256x256/apps

          cp "$EXE" $PKG_DIR${INSTALL_DIR}/bin/$APP_NAME
          chmod +x $PKG_DIR${INSTALL_DIR}/bin/$APP_NAME

      - name: Copy icon & desktop entry
        run: |
          PKG_DIR=$GITHUB_WORKSPACE/deb_build

          ICON_PATH=$PKG_DIR/usr/share/icons/hicolor/256x256/apps/${APP_NAME}.png
          if [ -f icons/$APP_NAME.png ]; then
            cp icons/$APP_NAME.png "$ICON_PATH"
          else
            convert -size 256x256 xc:none "$ICON_PATH"
          fi

          cat <<EOF > $PKG_DIR/usr/share/applications/${APP_NAME}.desktop
          [Desktop Entry]
          Name=Project Overwatch
          Exec=${INSTALL_DIR}/bin/${APP_NAME}
          Icon=${APP_NAME}
          Type=Application
          Categories=Utility;
          EOF

      - name: Copy Qt libraries
        run: |
          PKG_DIR=$GITHUB_WORKSPACE/deb_build
          QT_DIR=$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64

          cp -r $QT_DIR/lib/* $PKG_DIR${INSTALL_DIR}/lib/
          cp -r $QT_DIR/plugins/* $PKG_DIR${INSTALL_DIR}/plugins/
          cp -r $QT_DIR/qml/* $PKG_DIR${INSTALL_DIR}/qml/

      - name: Create control file
        run: |
          PKG_DIR=$GITHUB_WORKSPACE/deb_build
          cat <<EOF > $PKG_DIR/DEBIAN/control
          Package: ${PACKAGE_NAME}
          Version: ${PACKAGE_VERSION}
          Section: utils
          Priority: optional
          Architecture: ${ARCH}
          Maintainer: You
          Description: Project Overwatch GUI Application
          Depends: libglib2.0-0, libnss3, libasound2, libxss1, libxdamage1, libxcomposite1
          EOF

      - name: Create postinst
        run: |
          PKG_DIR=$GITHUB_WORKSPACE/deb_build

          cat <<'EOF' > $PKG_DIR/DEBIAN/postinst

          chmod +x /opt/project-overwatch/bin/*
          update-desktop-database
          EOF
          chmod 755 $PKG_DIR/DEBIAN/postinst

      - name: Build .deb
        run: |
          PKG_DIR=$GITHUB_WORKSPACE/deb_build
          dpkg-deb --build "$PKG_DIR" "${PACKAGE_NAME}_${PACKAGE_VERSION}_${ARCH}.deb"

      - name: Upload DEB artifact
        uses: actions/upload-artifact@v4
        with:
          name: project-overwatch-deb
          path: project-overwatch_*.deb

