name: Linux Qt Build (project-overwatch)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  linux-build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:20.04

    env:
      QT_VERSION: 6.5.3
      BUILD_DIR: build
      APP_NAME: appproject-overwatch
      APP_DIR: AppDir
      APPIMAGE_EXTRACT_AND_RUN: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y build-essential python3 python3-pip git wget mesa-common-dev libglib2.0-dev libgl1-mesa-dev libx11-dev libxkbcommon-x11-0 libxrender-dev libxext-dev libxfixes-dev libxkbcommon-dev
          pip3 install aqtinstall==3.1.18 py7zr bs4

      - name: Install Qt
        run: |
          python3 -m aqt install-qt linux desktop $QT_VERSION -m qt5compat qtimageformats qtmultimedia qtshadertools

      - name: Configure project
        run: |
          mkdir -p $BUILD_DIR
          cd $BUILD_DIR
          qmake ../

      - name: Build project
        run: |
          cd $BUILD_DIR
          make -j$(nproc)

      - name: Prepare AppDir
        run: |
          mkdir -p $APP_DIR/usr/bin
          cp $BUILD_DIR/$APP_NAME $APP_DIR/usr/bin/
          chmod +x $APP_DIR/usr/bin/$APP_NAME

          mkdir -p $APP_DIR/usr/share/applications
          cat <<EOF > $APP_DIR/usr/share/applications/$APP_NAME.desktop
          [Desktop Entry]
          Name=Project Overwatch
          Exec=$APP_NAME
          Icon=app
          Type=Application
          Categories=Utility;
          EOF

          mkdir -p $APP_DIR/usr/share/icons
          cp icons/app.png $APP_DIR/usr/share/icons/app.png

      - name: Download AppImageTool
        run: |
          wget -O appimagetool-x86_64.AppImage https://github.com/AppImage/AppImageKit/releases/download/13/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Create AppImage
        run: |
          ./appimagetool-x86_64.AppImage $APP_DIR ProjectOverwatch-x86_64.AppImage
          export APPIMAGE_PATH=ProjectOverwatch-x86_64.AppImage

      - name: Upload AppImage Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ProjectOverwatch-AppImage
          path: ProjectOverwatch-x86_64.AppImage

      ############################################################
      # NEW SECTION: Build .deb package (Option A placement)
      ############################################################

      - name: Create DEBIAN control file
        run: |
          mkdir -p debpkg/DEBIAN
          cat <<EOF > debpkg/DEBIAN/control
          Package: project-overwatch
          Version: 1.0.0
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: Developer <dev@example.com>
          Description: Project Overwatch Linux Application
          EOF

      - name: Copy application files into .deb structure
        run: |
          mkdir -p debpkg/usr/local/bin
          cp $BUILD_DIR/$APP_NAME debpkg/usr/local/bin/
          chmod 755 debpkg/usr/local/bin/$APP_NAME

          mkdir -p debpkg/usr/share/applications
          cp $APP_DIR/usr/share/applications/$APP_NAME.desktop debpkg/usr/share/applications/

          mkdir -p debpkg/usr/share/icons
          cp icons/app.png debpkg/usr/share/icons/app.png

      - name: Build .deb package
        run: |
          dpkg-deb --build debpkg
          mv debpkg.deb project-overwatch.deb

      - name: Upload .deb Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ProjectOverwatch-DEB
          path: project-overwatch.deb

      ############################################################
      # Continue existing workflow (QtIFW installer)
      ############################################################

      - name: Install Qt Installer Framework
        run: |
          python3 -m aqt list-tool linux desktop tools_ifw
          python3 -m aqt install-tool linux desktop tools_ifw 4.5

      - name: Build Qt Installer Framework package
        run: |
          IFW_PATH=/opt/Qt/Tools/QtInstallerFramework/4.5/bin
          mkdir -p installer/output
          $IFW_PATH/binarycreator -c installer/config/config.xml -p installer/packages installer/output/ProjectOverwatchInstaller

      - name: Upload Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ProjectOverwatch-Installer
          path: installer/output/ProjectOverwatchInstaller

