name: Linux Qt AppImage Build (project-overwatch)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  linux-appimage:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:20.04

    env:
      QT_VERSION: 6.5.3
      BUILD_DIR: build
      APP_NAME: appproject-overwatch
      INSTALL_DIR: /opt/project-overwatch
      APP_DIR: AppDir

    steps:

      - name: Install Git
        run: |
          apt-get update
          apt-get install -y software-properties-common
          add-apt-repository ppa:git-core/ppa -y
          apt-get update
          apt-get install -y git

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            build-essential cmake ninja-build patchelf wget curl imagemagick \
            libgl1-mesa-dev libglu1-mesa-dev libegl1-mesa-dev \
            libxkbcommon-dev libxkbcommon-x11-dev \
            libglib2.0-0 libglib2.0-dev libdbus-1-dev libfontconfig1-dev \
            libxcb-cursor0 libxcb-xinerama0 libxcb-util1 libx11-xcb1 \
            libxrender1 libxrandr2 libegl1 libglu1-mesa \
            libxcb-render-util0 libxcb-render0 libxcb-image0 libxcb-keysyms1 \
            libxcb-icccm4 libxcb-shape0 libxcb-xfixes0 libxcb-sync1 \
            libxcb-randr0 libxcb1-dev libx11-xcb-dev \
            libxkbfile-dev libxtst-dev libxt-dev libxinerama-dev \
            libnss3 libnspr4 libxss1 libasound2 libxcomposite1 libxdamage1 \
            python3 python3-pip locales

      - name: Install aqtinstall
        run: |
          pip3 install --upgrade pip
          pip3 install aqtinstall==3.1.18

      - name: Install Qt
        run: |
          python3 -m aqt install-qt linux desktop $QT_VERSION gcc_64 \
            --outputdir Qt \
            --modules qtcharts qtmultimedia qtshadertools qtpositioning qtwebchannel qtwebengine qtwebview qtserialport
          echo "CMAKE_PREFIX_PATH=$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64" >> $GITHUB_ENV

      - name: Configure CMake
        run: cmake -S . -B $BUILD_DIR -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build Project
        run: cmake --build $BUILD_DIR --parallel

      - name: Detect executable
        run: |
          EXE=$(find $BUILD_DIR -type f -executable -name "$APP_NAME*" | head -n 1)
          echo "EXE=$EXE" >> $GITHUB_ENV

      # ✅ MATCHES YOUR .DEB STRUCTURE EXACTLY
      - name: Create AppDir (Exact DEB Layout)
        run: |
          mkdir -p $APP_DIR${INSTALL_DIR}/bin
          mkdir -p $APP_DIR${INSTALL_DIR}/lib
          mkdir -p $APP_DIR${INSTALL_DIR}/qml
          mkdir -p $APP_DIR${INSTALL_DIR}/plugins
          mkdir -p $APP_DIR/usr/share/applications
          mkdir -p $APP_DIR/usr/share/icons/hicolor/256x256/apps

          cp "$EXE" $APP_DIR${INSTALL_DIR}/bin/$APP_NAME
          chmod +x $APP_DIR${INSTALL_DIR}/bin/$APP_NAME

      # ✅ SAME RUN SCRIPT AS .DEB
      - name: Create launcher wrapper
        run: |
          cat <<EOF > $APP_DIR${INSTALL_DIR}/bin/run-$APP_NAME.sh
          export LD_LIBRARY_PATH=${INSTALL_DIR}/lib:\$LD_LIBRARY_PATH
          export QT_PLUGIN_PATH=${INSTALL_DIR}/plugins
          export QT_QPA_PLATFORM_PLUGIN_PATH=${INSTALL_DIR}/plugins/platforms
          export QML2_IMPORT_PATH=${INSTALL_DIR}/qml
          exec ${INSTALL_DIR}/bin/${APP_NAME} "\$@"
          EOF
          chmod +x $APP_DIR${INSTALL_DIR}/bin/run-$APP_NAME.sh

      # ✅ ICON + DESKTOP ENTRY (SAME AS .DEB)
      - name: Install icon & desktop entry
        run: |
          cp icons/$APP_NAME.png $APP_DIR/usr/share/icons/hicolor/256x256/apps/$APP_NAME.png

          cat <<EOF > $APP_DIR/usr/share/applications/$APP_NAME.desktop
          [Desktop Entry]
          Name=Project Overwatch
          Exec=/opt/project-overwatch/bin/run-${APP_NAME}.sh
          Icon=${APP_NAME}
          Type=Application
          Categories=Utility;
          EOF

      # ✅ COPY FULL QT RUNTIME (LIKE .DEB)
      - name: Copy Qt runtime
        run: |
          QT_DIR=$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64
          cp -r $QT_DIR/lib/*     $APP_DIR${INSTALL_DIR}/lib/
          cp -r $QT_DIR/plugins/* $APP_DIR${INSTALL_DIR}/plugins/
          cp -r $QT_DIR/qml/*     $APP_DIR${INSTALL_DIR}/qml/

      # ✅ DOWNLOAD LINUXDEPLOY
      - name: Download linuxdeploy
        run: |
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

      # ✅ BUILD FINAL APPIMAGE
      - name: Build AppImage
        run: |
          ./linuxdeploy-x86_64.AppImage \
            --appdir $APP_DIR \
            --desktop-file $APP_DIR/usr/share/applications/$APP_NAME.desktop \
            --output appimage

      # ✅ UPLOAD RESULT
      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: project-overwatch-AppImage
          path: "*.AppImage"

