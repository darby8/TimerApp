name: Build Qt App (Linux + QtIFW Installer)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      BUILD_DIR: build
      QT_VERSION: 6.5.3
      QT_MODULES: qtcharts qtshadertools qtmultimedia
      GENERATOR: "Ninja"
      APP_NAME: project-overwatch

    steps:
      # Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ninja-build build-essential mesa-utils libgl1-mesa-dev \
            libxkbcommon-x11-0 libx11-xcb1 libfontconfig1 libxrender1 \
            libxcb-glx0 libxcb-keysyms1 libxcb-image0 libxcb-shm0 \
            libxcb-icccm4 libxcb-sync1 libxcb-xfixes0 libxcb-shape0 \
            libxcb-randr0 libxcb-render-util0 libxcb-util1 \
            xvfb wget curl unzip

      # Install Qt
      - name: Install Qt
        run: |
          pip install aqtinstall
          python3 -m aqt install-qt linux desktop ${QT_VERSION} gcc_64 \
            --outputdir Qt --modules ${QT_MODULES}
          echo "$GITHUB_WORKSPACE/Qt/${QT_VERSION}/gcc_64/bin" >> $GITHUB_PATH

      # Configure and build
      - name: Configure and build project
        run: |
          cmake -S . -B ${BUILD_DIR} -G "${GENERATOR}" \
            -DCMAKE_PREFIX_PATH="$GITHUB_WORKSPACE/Qt/${QT_VERSION}/gcc_64"
          cmake --build ${BUILD_DIR} --parallel

      # Install Qt Installer Framework (QtIFW)
      - name: Install Qt Installer Framework
        run: |
          echo "Downloading Qt Installer Framework (QtIFW)..."
          wget -q https://download.qt.io/official_releases/qt-installer-framework/4.6.0/QtInstallerFramework-linux-x64-4.6.0.run -O QtIFW.run
          chmod +x QtIFW.run

          echo "Installing QtIFW silently..."
          xvfb-run --auto-servernum ./QtIFW.run --script <(cat <<'EOF'
            function Controller() {
              installer.installationFinished.connect(function() {
                gui.clickButton(buttons.NextButton);
              });
            }
          EOF
          ) --accept-licenses --root "$GITHUB_WORKSPACE/QtIFW" --confirm-command install || true

          echo "$GITHUB_WORKSPACE/QtIFW/bin" >> $GITHUB_PATH
          echo "✅ Qt Installer Framework installed successfully"

      # Create Installer
      - name: Create Qt Installer
        run: |
          echo "Creating installer structure..."
          mkdir -p installer/config installer/packages/com.example.${APP_NAME}/data

          cp ${BUILD_DIR}/${APP_NAME} installer/packages/com.example.${APP_NAME}/data/
          cp -r QML installer/packages/com.example.${APP_NAME}/data/ || true
          cp -r resources installer/packages/com.example.${APP_NAME}/data/ || true

          cat > installer/config/config.xml <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <Installer>
              <Name>${APP_NAME}</Name>
              <Version>1.0.0</Version>
              <Title>${APP_NAME} Installer</Title>
              <Publisher>Your Company</Publisher>
              <StartMenuDir>${APP_NAME}</StartMenuDir>
              <TargetDir>@HomeDir@/${APP_NAME}</TargetDir>
          </Installer>
          EOF

          echo "Building installer..."
          $GITHUB_WORKSPACE/QtIFW/bin/binarycreator -c installer/config/config.xml -p installer/packages ${APP_NAME}-installer.run
          echo "✅ Installer created successfully: ${APP_NAME}-installer.run"

      # Upload artifact (so you can download the installer)
      - name: Upload Linux Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-Linux-Installer
          path: ${{ env.APP_NAME }}-installer.run

