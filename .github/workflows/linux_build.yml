name: Build Qt App (Linux - AppImage)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      BUILD_DIR: build
      QT_VERSION: 6.8.3
      QT_MODULES: qtdeclarative qtquickcontrols2 qtmultimedia qtcharts qtshadertools
      GENERATOR: "Ninja"
      APP_NAME: project-overwatch

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl1-mesa-dev libxkbcommon-x11-dev libxcb-cursor0 \
            libx11-xcb-dev libxkbfile-dev libxtst-dev libxinerama-dev \
            libxcursor-dev libxrandr-dev libxi-dev libxext-dev \
            libdbus-1-dev ninja-build wget patchelf fuse

      - name: Install Qt
        run: |
          pip install aqtinstall==3.1.6
          aqt install-qt linux desktop $QT_VERSION gcc_64 --modules $QT_MODULES --outputdir Qt

      - name: Configure and Build
        run: |
          cmake -B $BUILD_DIR -S . \
            -DCMAKE_PREFIX_PATH=$PWD/Qt/$QT_VERSION/gcc_64 \
            -DCMAKE_BUILD_TYPE=Release \
            -G "$GENERATOR"
          cmake --build $BUILD_DIR --parallel

      - name: Package as AppImage
        run: |
          set -e
          export VERSION=${{ github.ref_name || 'continuous' }}
          export APPDIR=$PWD/AppDir
          export APP_BINARY=$APPDIR/usr/bin/appproject-overwatch
          export QML_SOURCES_PATHS=$PWD/QML:$PWD/qml:$PWD/src

          echo "ðŸ—ï¸ Preparing AppDir..."
          mkdir -p $APPDIR/usr/bin
          mkdir -p $APPDIR/usr/share/applications
          mkdir -p $APPDIR/usr/share/icons/hicolor/256x256/apps

          cp $BUILD_DIR/appproject-overwatch $APP_BINARY

          ICON_SRC=assets/icons/appproject-overwatch.png
          if [ -f "$ICON_SRC" ]; then
            cp "$ICON_SRC" $APPDIR/usr/share/icons/hicolor/256x256/apps/
          else
            echo "âš ï¸ Icon not found, skipping icon deployment."
          fi

          cat > $APPDIR/usr/share/applications/$APP_NAME.desktop <<EOF
          [Desktop Entry]
          Name=Project Overwatch
          Exec=appproject-overwatch
          Icon=appproject-overwatch
          Type=Application
          Categories=Utility;
          EOF

          echo "ðŸ“¦ Downloading linuxdeploy + plugin..."
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage

          echo "ðŸš€ Deploying Qt + QML..."
          ./linuxdeploy-x86_64.AppImage --appdir $APPDIR \
            --plugin qt \
            -e $APP_BINARY \
            -d $APPDIR/usr/share/applications/$APP_NAME.desktop \
            -i $APPDIR/usr/share/icons/hicolor/256x256/apps/appproject-overwatch.png

          echo "ðŸ§± Building AppImage..."
          ./linuxdeploy-x86_64.AppImage --appdir $APPDIR --output appimage

          echo "âœ… Build complete:"
          ls -lh *.AppImage

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Project_Overwatch_AppImage
          path: "*.AppImage"

