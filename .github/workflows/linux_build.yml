name: Linux Qt Build (project-overwatch)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  linux-build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:20.04

    env:
      QT_VERSION: 6.5.3
      BUILD_DIR: build
      APP_NAME: appproject-overwatch
      APP_DIR: AppDir
      APPIMAGE_EXTRACT_AND_RUN: 1

    steps:
      # ✅ Install Git 2.40+ to avoid REST API fallback
      - name: Install Git
        run: |
          apt-get update
          apt-get install -y software-properties-common
          add-apt-repository ppa:git-core/ppa -y
          apt-get update
          apt-get install -y git

      # ✅ Checkout repository with submodules
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # ✅ Prepare environment (disable tzdata prompts)
      - name: Prepare environment
        run: |
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y tzdata locales
          locale-gen en_US.UTF-8
          update-locale LANG=en_US.UTF-8

      # ✅ Install base dependencies
      - name: Install dependencies
        run: |
          apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            patchelf \
            wget \
            curl \
            imagemagick \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libegl1-mesa-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev \
            libglib2.0-0 libglib2.0-dev \
            libdbus-1-dev \
            libfontconfig1-dev \
            libxcb-cursor0 libxcb-xinerama0 libxcb-util1 libx11-xcb1 \
            libxrender1 libxrandr2 libegl1 libglu1-mesa \
            libxcb-render-util0 libxcb-render0 libxcb-image0 libxcb-keysyms1 \
            libxcb-icccm4 libxcb-shape0 libxcb-xfixes0 libxcb-sync1 \
            libxcb-randr0 libxcb-xinerama0 libxcb-cursor0 libxcb1-dev \
            libx11-xcb-dev \
            libxkbfile-dev \
            libxtst-dev \
            libxt-dev \
            libxinerama-dev

      # ✅ Install database libraries
      - name: Install PostgreSQL/MySQL/ODBC libraries
        run: |
          apt-get install -y libpq-dev libpq5 libmysqlclient-dev \
            unixodbc unixodbc-dev odbcinst odbcinst1debian2

      # ✅ Install Python & aqtinstall
      - name: Install Python & aqt
        run: |
          apt-get install -y python3 python3-pip
          pip3 install --upgrade pip
          pip3 install aqtinstall==3.1.18

      # ✅ Install Qt 6.5.3
      - name: Install Qt ${{ env.QT_VERSION }}
        run: |
          python3 -m aqt install-qt linux desktop $QT_VERSION gcc_64 \
            --outputdir Qt \
            --modules qtcharts qtmultimedia qtshadertools qtpositioning qtwebchannel qtwebengine qtwebview qtserialport
          echo "CMAKE_PREFIX_PATH=$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64" >> $GITHUB_ENV

      # ✅ Configure CMake
      - name: Configure CMake
        run: |
          cmake -S . -B $BUILD_DIR -G Ninja \
            -DCMAKE_PREFIX_PATH="$CMAKE_PREFIX_PATH" \
            -DCMAKE_BUILD_TYPE=Release

      # ✅ Build project
      - name: Build Project
        run: cmake --build $BUILD_DIR --config Release --parallel

      # ✅ Detect built executable
      - name: Detect executable
        id: findexe
        run: |
          EXE=$(find $BUILD_DIR -maxdepth 2 -type f -executable -name "$APP_NAME*" | head -n 1)
          echo "EXE=$EXE" >> $GITHUB_ENV
          echo "Found executable: $EXE"

      # ✅ Create AppDir structure and handle icon
      - name: Create AppDir
        run: |
          mkdir -p $APP_DIR/usr/bin $APP_DIR/usr/share/applications $APP_DIR/usr/share/icons/hicolor/256x256/apps
          cp "$EXE" $APP_DIR/usr/bin/$APP_NAME
          chmod +x $APP_DIR/usr/bin/$APP_NAME

          # Copy icon (must be: icons/appproject-overwatch.png)
          if [ -f icons/$APP_NAME.png ]; then
            cp icons/$APP_NAME.png $APP_DIR/usr/share/icons/hicolor/256x256/apps/$APP_NAME.png
          else
            # placeholder icon if missing
            convert -size 256x256 xc:none $APP_DIR/usr/share/icons/hicolor/256x256/apps/$APP_NAME.png || touch $APP_DIR/usr/share/icons/hicolor/256x256/apps/$APP_NAME.png
          fi

          cat <<EOF > $APP_DIR/usr/share/applications/$APP_NAME.desktop
          [Desktop Entry]
          Name=Project Overwatch
          Exec=$APP_NAME
          Icon=$APP_NAME
          Type=Application
          Categories=Utility;
          EOF

      # ✅ Download linuxdeploy
      - name: Download linuxdeploy & plugin
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage

      # ✅ Download linuxdeployqt
      - name: Download linuxdeployqt
        run: |
          wget -q https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage -O linuxdeployqt
          chmod +x linuxdeployqt



      - name: Install QtWebEngine runtime dependencies
        run: |
          apt-get update
          apt-get install -y \
            libnss3 \
            libnspr4 \
            libxss1 \
            libasound2 \
            libxcomposite1 \
            libxdamage1 \
            locales
          # ✅ Ensure UTF-8 locale to silence the warning
          locale-gen en_US.UTF-8
          update-locale LANG=en_US.UTF-8



      - name: Build AppImage
        run: |
          export PATH="$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64/bin:$PATH"
          export QML_IMPORT_PATH="$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64/qml"
          export QML2_IMPORT_PATH="$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64/qml"
          export QT_PLUGIN_PATH="$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64/plugins"

          echo "Running linuxdeployqt with proper QML directory..."
          ./linuxdeployqt \
            $APP_DIR/usr/share/applications/$APP_NAME.desktop \
            -qmldir="$GITHUB_WORKSPACE/QML" \
            -qmake=$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64/bin/qmake \
            -bundle-non-qt-libs \
            -appimage


      - name: Install Qt Installer Framework (QtIFW)
        run: |
          echo "Listing available Qt Installer Framework versions..."
          python3 -m aqt list-tool linux desktop tools_ifw | tail -n 10 || true

          # Detect latest available IFW version (fallback to 4.7.0 if not found)
          IFW_VERSION=$(python3 -m aqt list-tool linux desktop tools_ifw 2>/dev/null | grep -Eo '[0-9]+\.[0-9]+\.[0-9]+' | tail -n 1)
          IFW_VERSION=${IFW_VERSION:-4.7.0}
          echo "Detected IFW version: $IFW_VERSION"

         # Install IFW under QtIFW/
          python3 -m aqt install-tool linux desktop tools_ifw $IFW_VERSION --outputdir QtIFW

         # Add IFW binaries (binarycreator, repogen, etc.) to PATH
          export PATH="$GITHUB_WORKSPACE/QtIFW/Tools/QtInstallerFramework/$IFW_VERSION/bin:$PATH"
          echo "$GITHUB_WORKSPACE/QtIFW/Tools/QtInstallerFramework/$IFW_VERSION/bin" >> $GITHUB_PATH

          echo "✅ Qt Installer Framework $IFW_VERSION installed successfully."



      # ✅ Create QtIFW directory structure
      - name: Create installer structure
        run: |
          mkdir -p installer/config
          mkdir -p installer/packages/com.project.overwatch/meta
          mkdir -p installer/packages/com.project.overwatch/data

          cat <<EOF > installer/config/config.xml
          <Installer>
              <Name>Project Overwatch</Name>
              <Version>1.0.0</Version>
              <Title>Project Overwatch Installer</Title>
              <Publisher>YourCompany</Publisher>
              <StartMenuDir>Project Overwatch</StartMenuDir>
              <TargetDir>@HomeDir@/ProjectOverwatch</TargetDir>
          </Installer>
          EOF

          cat <<EOF > installer/packages/com.project.overwatch/meta/package.xml
          <Package>
              <DisplayName>Project Overwatch</DisplayName>
              <Description>Qt-based monitoring application</Description>
              <Version>1.0.0</Version>
              <ReleaseDate>$(date +%Y-%m-%d)</ReleaseDate>
              <Default>true</Default>
              <Script>installscript.qs</Script>
          </Package>
          EOF

          cat <<'EOF' > installer/packages/com.project.overwatch/meta/installscript.qs
          function Component() {}
          Component.prototype.createOperations = function() {
              component.createOperations();
          }
          EOF

          # Copy AppImage or binary into data folder
          cp ./*.AppImage installer/packages/com.project.overwatch/data/ || true
          cp $BUILD_DIR/$APP_NAME installer/packages/com.project.overwatch/data/ || true

      # ✅ Build the installer using binarycreator
      - name: Build Qt Installer
        run: |
          export PATH="$GITHUB_WORKSPACE/QtIFW/Tools/QtInstallerFramework/4.7/bin:$PATH"
          binarycreator --config installer/config/config.xml \
                        --packages installer/packages \
                        ProjectOverwatchInstaller.run

      # ✅ Upload installer
      - name: Upload Qt Installer
        uses: actions/upload-artifact@v4
        with:
          name: project-overwatch-linux-installer
          path: ProjectOverwatchInstaller.run


