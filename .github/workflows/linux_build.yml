name: Linux Qt Build & AppImage (project-overwatch)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  linux-build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:20.04

    env:
      QT_VERSION: 6.5.3
      BUILD_DIR: build
      APP_NAME: Project_Overwatch
      APP_DIR: AppDir

    steps:
      # 1Ô∏è‚É£ Checkout repo with submodules
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0  # Ensures full repo clone


      # 2Ô∏è‚É£ Install base dependencies
      - name: Install system dependencies
        run: |
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y \
            build-essential cmake ninja-build wget curl patchelf \
            libgl1-mesa-dev libglu1-mesa-dev libegl1-mesa-dev \
            libxkbcommon-dev libxkbcommon-x11-dev \
            libglib2.0-0 libglib2.0-dev libdbus-1-dev libfontconfig1-dev \
            libxcb-cursor0 libxcb-xinerama0 libxcb-util1 libx11-xcb1 \
            libxrender1 libxrandr2 libxcb-render-util0 libxcb-render0 \
            libxcb-image0 libxcb-keysyms1 libxcb-icccm4 libxcb-shape0 \
            libxcb-xfixes0 libxcb-sync1 libxcb-randr0 libxcb-xinerama0 \
            libxcb-cursor0 libxcb1-dev libx11-xcb-dev libxkbfile-dev \
            libxtst-dev libxt-dev libxinerama-dev \
            libpq-dev libmysqlclient-dev unixodbc unixodbc-dev odbcinst \
            odbcinst1debian2 imagemagick

      # 3Ô∏è‚É£ Install Python & aqtinstall
      - name: Install Python & aqt
        run: |
          apt-get install -y python3 python3-pip
          pip3 install --upgrade pip
          pip3 install aqtinstall==3.1.18

      # 4Ô∏è‚É£ Install Qt 6.5.3 (Linux GCC 64-bit)
      - name: Install Qt 6.5.3
        run: |
          python3 -m aqt install-qt linux desktop $QT_VERSION gcc_64 \
            --outputdir Qt \
            --modules qtcharts qtmultimedia qtshadertools qtpositioning qtwebchannel qtwebengine qtwebview
          echo "CMAKE_PREFIX_PATH=$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64" >> $GITHUB_ENV

      # 5Ô∏è‚É£ Configure CMake
      - name: Configure CMake
        run: |
          cmake -S . -B $BUILD_DIR -G Ninja \
            -DCMAKE_PREFIX_PATH="$CMAKE_PREFIX_PATH" \
            -DCMAKE_BUILD_TYPE=Release

      # 6Ô∏è‚É£ Build Project
      - name: Build Project
        run: cmake --build $BUILD_DIR --config Release --parallel

      # 7Ô∏è‚É£ Detect built executable
      - name: Detect executable
        id: findexe
        run: |
          EXE=$(find $BUILD_DIR -maxdepth 2 -type f -executable -name "$APP_NAME*" | head -n 1)
          echo "EXE=$EXE" >> $GITHUB_ENV
          echo "Found executable: $EXE"

      # 8Ô∏è‚É£ Prepare AppDir
      - name: Create AppDir structure
        run: |
          mkdir -p $APP_DIR/usr/bin $APP_DIR/usr/share/applications
          cp "$EXE" $APP_DIR/usr/bin/$APP_NAME
          chmod +x $APP_DIR/usr/bin/$APP_NAME

          # Copy QML folder
          if [ -d QML ]; then
            cp -r QML $APP_DIR/usr/
          fi

          # Create a minimal icon placeholder if none exists
          mkdir -p $APP_DIR/usr/share/icons/hicolor/256x256/apps
          if [ -f icons/$APP_NAME.png ]; then
            cp icons/$APP_NAME.png $APP_DIR/usr/share/icons/hicolor/256x256/apps/$APP_NAME.png
          else
            convert -size 256x256 xc:none $APP_DIR/usr/share/icons/hicolor/256x256/apps/$APP_NAME.png || touch $APP_DIR/usr/share/icons/hicolor/256x256/apps/$APP_NAME.png
          fi

          # Desktop entry
          cat <<EOF > $APP_DIR/usr/share/applications/$APP_NAME.desktop
          [Desktop Entry]
          Name=Project Overwatch
          Exec=$APP_NAME
          Icon=$APP_NAME
          Type=Application
          Categories=Utility;
          EOF

      # 9Ô∏è‚É£ Download linuxdeployqt
      - name: Download linuxdeployqt
        run: |
          wget -q https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage -O linuxdeployqt
          chmod +x linuxdeployqt

      # üîü Build AppImage
      - name: Build AppImage
        run: |
          export PATH="$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64/bin:$PATH"
          export QML_IMPORT_PATH="$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64/qml"
          export QML2_IMPORT_PATH="$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64/qml"
          export QT_PLUGIN_PATH="$GITHUB_WORKSPACE/Qt/$QT_VERSION/gcc_64/plugins"

          ./linuxdeployqt \
            $APP_DIR/usr/share/applications/$APP_NAME.desktop \
            -appimage \
            -bundle-non-qt-libs

      # 1Ô∏è‚É£1Ô∏è‚É£ Upload AppImage artifact
      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: project-overwatch-Linux-AppImage
          path: "*.AppImage"

